# üê≥ DOCKER: ORCHESTRATION & BEST PRACTICES

- [üê≥ DOCKER: ORCHESTRATION \& BEST PRACTICES](#-docker-orchestration--best-practices)
  - [üéØ M·ª•c Ti√™u](#-m·ª•c-ti√™u)
  - [1. ‚è™ √în L·∫°i ph·∫ßn tr∆∞·ªõc](#1--√¥n-l·∫°i-ph·∫ßn-tr∆∞·ªõc)
    - [Key Concepts: Image, Container, Dockerfile, Registry](#key-concepts-image-container-dockerfile-registry)
    - [Basic Docker CLI Commands](#basic-docker-cli-commands)
  - [2. üöÄ Gi·ªõi Thi·ªáu Docker Compose](#2--gi·ªõi-thi·ªáu-docker-compose)
    - [T·∫°i sao c·∫ßn Docker Compose? V·∫•n ƒë·ªÅ v·ªõi nhi·ªÅu `docker run`](#t·∫°i-sao-c·∫ßn-docker-compose-v·∫•n-ƒë·ªÅ-v·ªõi-nhi·ªÅu-docker-run)
    - [Docker Compose l√† g√¨?](#docker-compose-l√†-g√¨)
    - [C√†i ƒë·∫∑t Docker Compose](#c√†i-ƒë·∫∑t-docker-compose)
  - [3. üéº C√∫ Ph√°p `docker-compose.yml`](#3--c√∫-ph√°p-docker-composeyml)
    - [`version`](#version)
    - [`services`](#services)
    - [`build` vs `image`](#build-vs-image)
    - [`ports`](#ports)
    - [`volumes`](#volumes)
    - [`environment`](#environment)
    - [`env_file`](#env_file)
    - [`depends_on`](#depends_on)
    - [`networks`](#networks)
    - [`command`](#command)
    - [`entrypoint`](#entrypoint)
    - [`restart`](#restart)
    - [`healthcheck`](#healthcheck)
    - [`expose`](#expose)
    - [`extends`](#extends)
    - [`secrets` v√† `configs`](#secrets-v√†-configs)
    - [V√≠ d·ª• `docker-compose.yml` ƒë∆°n gi·∫£n](#v√≠-d·ª•-docker-composeyml-ƒë∆°n-gi·∫£n)
    - [C√°c l·ªánh Docker Compose c∆° b·∫£n](#c√°c-l·ªánh-docker-compose-c∆°-b·∫£n)
  - [4. üîó Docker Networking (v·ªõi Compose)](#4--docker-networking-v·ªõi-compose)
    - [M·∫°ng m·∫∑c ƒë·ªãnh (Default Bridge Network)](#m·∫°ng-m·∫∑c-ƒë·ªãnh-default-bridge-network)
    - [K·∫øt n·ªëi gi·ªØa c√°c services (Service Discovery)](#k·∫øt-n·ªëi-gi·ªØa-c√°c-services-service-discovery)
    - [Custom Networks](#custom-networks)
  - [5. üíæ Docker Volumes (v·ªõi Compose)](#5--docker-volumes-v·ªõi-compose)
    - [T·∫°i sao c·∫ßn Volumes? (Data Persistence)](#t·∫°i-sao-c·∫ßn-volumes-data-persistence)
    - [C√°c lo·∫°i Volumes trong Docker](#c√°c-lo·∫°i-volumes-trong-docker)
    - [Khai b√°o v√† s·ª≠ d·ª•ng Volumes trong Compose](#khai-b√°o-v√†-s·ª≠-d·ª•ng-volumes-trong-compose)
  - [6. üõ†Ô∏è Th·ª±c H√†nh: X√¢y D·ª±ng ·ª®ng D·ª•ng Web + Database + Cache v·ªõi Docker Compose](#6-Ô∏è-th·ª±c-h√†nh-x√¢y-d·ª±ng-·ª©ng-d·ª•ng-web--database--cache-v·ªõi-docker-compose)
  - [7. ‚ú® Best Practices \& M·∫πo](#7--best-practices--m·∫πo)
    - [Dockerfile Best Practices (Nh·∫Øc l·∫°i v√† b·ªï sung)](#dockerfile-best-practices-nh·∫Øc-l·∫°i-v√†-b·ªï-sung)
    - [Docker Compose Best Practices](#docker-compose-best-practices)
    - [S·ª≠ d·ª•ng `.dockerignore`](#s·ª≠-d·ª•ng-dockerignore)
    - [Qu·∫£n l√Ω m√¥i tr∆∞·ªùng (Dev, Staging, Prod)](#qu·∫£n-l√Ω-m√¥i-tr∆∞·ªùng-dev-staging-prod)
  - [8. üèãÔ∏è B√†i T·∫≠p](#8-Ô∏è-b√†i-t·∫≠p)
  - [9. üìö T√†i Li·ªáu Tham Kh·∫£o \& Next Steps](#9--t√†i-li·ªáu-tham-kh·∫£o--next-steps)

---

## üéØ M·ª•c Ti√™u

- Hi·ªÉu r√µ vai tr√≤, l·ª£i √≠ch c·ªßa **Docker Compose** trong vi·ªác qu·∫£n l√Ω ·ª©ng d·ª•ng ƒëa-container.
- N·∫Øm v·ªØng c√∫ ph√°p v√† c√°c ch·ªâ th·ªã quan tr·ªçng c·ªßa file `docker-compose.yml`.
- Bi·∫øt c√°ch ƒë·ªãnh nghƒ©a v√† qu·∫£n l√Ω **services**, **networks**, v√† **volumes** m·ªôt c√°ch hi·ªáu qu·∫£ v·ªõi Docker Compose.
- Th·ª±c h√†nh x√¢y d·ª±ng m·ªôt ·ª©ng d·ª•ng **multi-container** ph·ª©c t·∫°p h∆°n, bao g·ªìm web, database v√† caching.
- T√¨m hi·ªÉu v√† √°p d·ª•ng c√°c **best practices** khi l√†m vi·ªác v·ªõi Docker v√† Docker Compose ƒë·ªÉ t·ªëi ∆∞u h√≥a quy tr√¨nh ph√°t tri·ªÉn v√† tri·ªÉn khai.
- Hi·ªÉu c√°ch Docker Compose ƒë∆°n gi·∫£n h√≥a vi·ªác thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng ph√°t tri·ªÉn v√† ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n.

---

## 1. ‚è™ √în L·∫°i ph·∫ßn tr∆∞·ªõc

### Key Concepts: Image, Container, Dockerfile, Registry

- **Image**: Template read-only, ch·ª©a m·ªçi th·ª© c·∫ßn ƒë·ªÉ ch·∫°y ·ª©ng d·ª•ng (code, runtime, libraries, environment variables, config files). ƒê∆∞·ª£c build t·ª´ Dockerfile.
- **Container**: Instance ch·∫°y c·ªßa m·ªôt image. L√† m·ªôt m√¥i tr∆∞·ªùng isolated, c√≥ filesystem, process, network ri√™ng, nh∆∞ng chia s·∫ª kernel c·ªßa Host OS.
- **Dockerfile**: File text ch·ª©a c√°c instructions (l·ªánh) ƒë·ªÉ Docker Engine t·ª± ƒë·ªông build m·ªôt image.
- **Registry**: Kho l∆∞u tr·ªØ v√† ph√¢n ph·ªëi Docker images (VD: Docker Hub, AWS ECR, Google GCR).

### Basic Docker CLI Commands

- `docker build -t <name:tag> .`: Build image t·ª´ Dockerfile.
- `docker run [OPTIONS] <image>`: Ch·∫°y container t·ª´ image.
  - Options quan tr·ªçng: `-d` (detached), `-p HOST_PORT:CONTAINER_PORT`, `--name`, `-it` (interactive), `--rm` (auto-remove), `-v HOST_PATH:CONTAINER_PATH` (volume), `-e VAR=value`.
- `docker ps [-a]`: Li·ªát k√™ containers (ƒëang ch·∫°y / t·∫•t c·∫£).
- `docker images`: Li·ªát k√™ images.
- `docker stop/start/restart <container>`: Qu·∫£n l√Ω lifecycle container.
- `docker rm <container>`: X√≥a container (ph·∫£i d·ª´ng tr∆∞·ªõc, ho·∫∑c d√πng `-f`).
- `docker rmi <image>`: X√≥a image (ph·∫£i kh√¥ng c√≥ container n√†o d√πng, ho·∫∑c d√πng `-f`).
- `docker logs [-f] <container>`: Xem logs.
- `docker exec -it <container> <command>`: Ch·∫°y l·ªánh trong container ƒëang ch·∫°y.
- `docker pull <image>` / `docker push <repo/image>`: T∆∞∆°ng t√°c v·ªõi registry.

## 2. üöÄ Gi·ªõi Thi·ªáu Docker Compose

### T·∫°i sao c·∫ßn Docker Compose? V·∫•n ƒë·ªÅ v·ªõi nhi·ªÅu `docker run`

H√£y t∆∞·ªüng t∆∞·ª£ng m·ªôt ·ª©ng d·ª•ng web hi·ªán ƒë·∫°i th∆∞·ªùng bao g·ªìm nhi·ªÅu th√†nh ph·∫ßn (services) ph·ªëi h·ª£p v·ªõi nhau:

- M·ªôt `web server` (Nginx, Apache) ƒë·ªÉ ph·ª•c v·ª• static files ho·∫∑c l√†m reverse proxy.
- M·ªôt `application server` (Node.js, Python/Django/Flask, Java/Spring Boot, Ruby/Rails, PHP/Laravel) ch·ª©a business logic.
- M·ªôt `database` (PostgreSQL, MySQL, MongoDB, etc.) ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu.
- C√≥ th·ªÉ th√™m m·ªôt `caching service` (Redis, Memcached) ƒë·ªÉ tƒÉng t·ªëc ƒë·ªô.
- C√≥ th·ªÉ th√™m `message queue` (RabbitMQ, Kafka) cho x·ª≠ l√Ω b·∫•t ƒë·ªìng b·ªô.

N·∫øu d√πng `docker run` cho t·ª´ng service, b·∫°n s·∫Ω ph·∫£i ƒë·ªëi m·∫∑t v·ªõi:

```bash
# Ch·∫°y database (VD: Postgres)
docker run -d --name my_db \
  -e POSTGRES_USER=user \
  -e POSTGRES_PASSWORD=secret \
  -e POSTGRES_DB=appdb \
  -v db_data:/var/lib/postgresql/data \
  --network app_net \
  postgres:14-alpine

# Ch·∫°y backend app, link t·ªõi DB, expose port
# C·∫ßn ƒë·ª£i DB s·∫µn s√†ng, bi·∫øt IP c·ªßa DB (ho·∫∑c d√πng Docker network v√† t√™n service)
docker run -d --name my_app \
  --network app_net \
  -p 3000:3000 \
  -e DATABASE_URL="postgresql://user:secret@my_db:5432/appdb" \
  -e NODE_ENV=development \
  -v ./app_src:/usr/src/app \
  my_backend_image:latest

# Ch·∫°y frontend (VD: Nginx ph·ª•c v·ª• static files v√† proxy API)
docker run -d --name my_frontend \
  --network app_net \
  -p 80:80 \
  -v ./frontend_static:/usr/share/nginx/html \
  -v ./nginx.conf:/etc/nginx/nginx.conf:ro \
  nginx:alpine

# V√† c√≥ th·ªÉ c√≤n nhi·ªÅu services kh√°c...
```

**Nh·ªØng kh√≥ khƒÉn:**

- **Qu√° nhi·ªÅu l·ªánh `docker run` d√†i v√† ph·ª©c t·∫°p:** Kh√≥ nh·ªõ, d·ªÖ g√µ sai.
- **Qu·∫£n l√Ω dependencies:** Service A c·∫ßn Service B ch·∫°y tr∆∞·ªõc v√† s·∫µn s√†ng (VD: app c·∫ßn DB). `docker run` kh√¥ng c√≥ c∆° ch·∫ø `depends_on` r√µ r√†ng.
- **Qu·∫£n l√Ω network:** Ph·∫£i t·ª± t·∫°o Docker network (`docker network create app_net`) v√† k·∫øt n·ªëi c√°c container v√†o ƒë√≥ ƒë·ªÉ ch√∫ng th·∫•y nhau.
- **Qu·∫£n l√Ω volumes:** Khai b√°o volumes cho t·ª´ng service.
- **C·∫•u h√¨nh:** Truy·ªÅn bi·∫øn m√¥i tr∆∞·ªùng, mount config files cho t·ª´ng service.
- **Kh√≥ chia s·∫ª v√† t√°i t·∫°o:** ƒê∆∞a cho ƒë·ªìng nghi·ªáp m·ªôt lo·∫°t l·ªánh `docker run` ƒë·ªÉ setup m√¥i tr∆∞·ªùng l√† kh√¥ng hi·ªáu qu·∫£ v√† d·ªÖ l·ªói.
- **Kh√≥ scale (·ªü m·ª©c c∆° b·∫£n):** Mu·ªën ch·∫°y nhi·ªÅu instance c·ªßa m·ªôt service s·∫Ω ph·ª©c t·∫°p.
- **D·ª´ng v√† d·ªçn d·∫πp:** Ph·∫£i `docker stop` v√† `docker rm` t·ª´ng container m·ªôt.

Docker Compose ƒë∆∞·ª£c sinh ra ƒë·ªÉ gi·∫£i quy·∫øt t·∫•t c·∫£ nh·ªØng v·∫•n ƒë·ªÅ n√†y.

### Docker Compose l√† g√¨?

- L√† m·ªôt c√¥ng c·ª• d√≤ng l·ªánh (CLI tool) ƒë·ªÉ **ƒë·ªãnh nghƒ©a (define)** v√† **ch·∫°y (run)** c√°c ·ª©ng d·ª•ng Docker **ƒëa-container (multi-container)** m·ªôt c√°ch d·ªÖ d√†ng.
- S·ª≠ d·ª•ng m·ªôt file c·∫•u h√¨nh duy nh·∫•t vi·∫øt b·∫±ng **YAML** (th∆∞·ªùng l√† `docker-compose.yml`) ƒë·ªÉ m√¥ t·∫£ to√†n b·ªô "stack" ·ª©ng d·ª•ng c·ªßa b·∫°n, bao g·ªìm:
  - C√°c `services` (t∆∞∆°ng ·ª©ng v·ªõi c√°c containers).
  - C·∫•u h√¨nh cho t·ª´ng service: image n√†o ƒë·ªÉ build/pull, ports, volumes, environment variables, dependencies, networks, etc.
  - `Networks` m√† c√°c services s·∫Ω k·∫øt n·ªëi v√†o.
  - `Volumes` ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu b·ªÅn b·ªâ.
- V·ªõi m·ªôt l·ªánh duy nh·∫•t (v√≠ d·ª•: `docker-compose up`), b·∫°n c√≥ th·ªÉ kh·ªüi t·∫°o, c·∫•u h√¨nh v√† ch·∫°y to√†n b·ªô ·ª©ng d·ª•ng v·ªõi t·∫•t c·∫£ c√°c services li√™n quan.

**L·ª£i √≠ch ch√≠nh c·ªßa Docker Compose:**

- **ƒê∆°n gi·∫£n h√≥a qu·∫£n l√Ω:** T·∫•t c·∫£ c·∫•u h√¨nh n·∫±m trong m·ªôt file, d·ªÖ ƒë·ªçc, d·ªÖ hi·ªÉu, d·ªÖ qu·∫£n l√Ω.
- **T√°i t·∫°o m√¥i tr∆∞·ªùng nh·∫•t qu√°n:** ƒê·∫£m b·∫£o m√¥i tr∆∞·ªùng ph√°t tri·ªÉn, testing, staging gi·ªëng nhau cho m·ªçi th√†nh vi√™n trong team v√† tr√™n c√°c m√°y kh√°c nhau.
- **Ph√°t tri·ªÉn nhanh h∆°n:** Setup m√¥i tr∆∞·ªùng nhanh ch√≥ng, t·∫≠p trung v√†o code thay v√¨ loay hoay c·∫•u h√¨nh.
- **T√≠ch h·ª£p t·ªët v·ªõi Docker Engine:** S·ª≠ d·ª•ng c√°c kh√°i ni·ªám Docker quen thu·ªôc.
- **Qu·∫£n l√Ω v√≤ng ƒë·ªùi ·ª©ng d·ª•ng d·ªÖ d√†ng:** `up`, `down`, `start`, `stop`, `restart` to√†n b·ªô stack ho·∫∑c t·ª´ng service.
- **C√¥ l·∫≠p m√¥i tr∆∞·ªùng:** M·ªói project Compose c√≥ th·ªÉ ch·∫°y ƒë·ªôc l·∫≠p m√† kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn nhau.

```text
                            +----------------------------+
                            |     docker-compose.yml     |
                            | (ƒê·ªãnh nghƒ©a App Stack)      |
                            +-------------+--------------+
                                          | (Input cho)
                                          v
+---------------------------------------+----------------------------------------+
|                               DOCKER COMPOSE CLI                               |
| (`docker-compose up`, `down`, `ps`, `logs`, `exec`, etc.)                      |
+---------------------------------------+----------------------------------------+
                                          | (Ra l·ªánh cho Docker Daemon)
                                          v
+--------------------------------------------------------------------------------+
|                                  DOCKER HOST                                   |
| +----------------------------------------------------------------------------+ |
| |                              Docker Daemon                                 | |
| |  (T·∫°o v√† qu·∫£n l√Ω containers, networks, volumes d·ª±a tr√™n docker-compose.yml) | |
| |                                                                            | |
| |  +------------------ Network: myproject_default ------------------------+  | |
| |  |                                                                      |  | |
| |  | +-----------------+  <-- communicates via service name --> +---------+ |  | |
| |  | | Service: web    |                                      | Service:db| |  | |
| |  | | (Container 1)   |                                      | (Cont. 3) | |  | |
| |  | | - Nginx/Node.js |  <-- communicates via service name --> +---------+ |  | |
| |  | | - Port 80 mapped|                                      | - Postgres| |  | |
| |  | +-----------------+  <-- communicates via service name --> +---------+ |  | |
| |  |         ^                                                  | Service:api| |  | |
| |  |         | (communicates via service name)                  | (Cont. 2) | |  | |
| |  |         +--------------------------------------------------+ - Python  | |  | |
| |  |                                                              +---------+ |  | |
| |  +--------------------------------------------------------------------------+  | |
| +----------------------------------------------------------------------------+ |
+--------------------------------------------------------------------------------+
  (Volume: myproject_db_data) <--- (Persists data for db service)
```

### C√†i ƒë·∫∑t Docker Compose

- **Docker Desktop (Windows, macOS):** Docker Compose th∆∞·ªùng ƒë∆∞·ª£c c√†i ƒë·∫∑t s·∫µn c√πng v·ªõi Docker Desktop. B·∫°n kh√¥ng c·∫ßn c√†i ri√™ng.
- **Linux:**

  - Th∆∞·ªùng ph·∫£i c√†i ƒë·∫∑t ri√™ng. C√°ch ph·ªï bi·∫øn l√† t·∫£i binary t·ª´ GitHub releases c·ªßa Docker Compose.
  - Tham kh·∫£o h∆∞·ªõng d·∫´n c√†i ƒë·∫∑t ch√≠nh th·ª©c: [https://docs.docker.com/compose/install/](https://docs.docker.com/compose/install/)
  - L·ªánh v√≠ d·ª• (phi√™n b·∫£n c√≥ th·ªÉ thay ƒë·ªïi, lu√¥n ki·ªÉm tra trang ch·ªß):

    ```bash
    # T·∫£i phi√™n b·∫£n ·ªïn ƒë·ªãnh m·ªõi nh·∫•t
    LATEST_COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d\" -f4)
    sudo curl -L "https://github.com/docker/compose/releases/download/${LATEST_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose

    # Ki·ªÉm tra c√†i ƒë·∫∑t
    docker-compose --version
    ```

  - M·ªôt s·ªë b·∫£n ph√¢n ph·ªëi Linux c√≥ th·ªÉ cung c·∫•p Docker Compose qua package manager (`apt`, `yum`), nh∆∞ng phi√™n b·∫£n c√≥ th·ªÉ c≈© h∆°n.

L∆∞u √Ω: `docker-compose` (c√≥ d·∫•u g·∫°ch n·ªëi) l√† phi√™n b·∫£n V1. `docker compose` (kh√¥ng c√≥ d·∫•u g·∫°ch n·ªëi) l√† phi√™n b·∫£n V2, ƒë∆∞·ª£c t√≠ch h·ª£p tr·ª±c ti·∫øp v√†o Docker CLI. Hi·ªán t·∫°i, V2 ƒë∆∞·ª£c khuy·∫øn kh√≠ch s·ª≠ d·ª•ng. N·∫øu Docker Desktop c·ªßa b·∫°n m·ªõi, `docker compose` s·∫Ω ho·∫°t ƒë·ªông. Tr√™n Linux, c√†i ƒë·∫∑t tr√™n c√≥ th·ªÉ l√† V1 ho·∫∑c V2 t√πy phi√™n b·∫£n. V·ªÅ c∆° b·∫£n, c√∫ ph√°p file YAML v√† c√°c l·ªánh ch√≠nh l√† t∆∞∆°ng t·ª±.

## 3. üéº C√∫ Ph√°p `docker-compose.yml`

File `docker-compose.yml` l√† m·ªôt file text ƒë·ªãnh d·∫°ng YAML, l√† tr√°i tim c·ªßa Docker Compose. YAML (YAML Ain't Markup Language) l√† m·ªôt ƒë·ªãnh d·∫°ng tu·∫ßn t·ª± h√≥a d·ªØ li·ªáu d·ªÖ ƒë·ªçc cho con ng∆∞·ªùi, s·ª≠ d·ª•ng th·ª•t ƒë·∫ßu d√≤ng (indentation) ƒë·ªÉ bi·ªÉu th·ªã c·∫•u tr√∫c. **QUAN TR·ªåNG: YAML r·∫•t nh·∫°y c·∫£m v·ªõi th·ª•t ƒë·∫ßu d√≤ng. Lu√¥n s·ª≠ d·ª•ng spaces, kh√¥ng d√πng tabs, v√† th·ª•t ƒë·∫ßu d√≤ng nh·∫•t qu√°n (th∆∞·ªùng l√† 2 spaces).**

File n√†y th∆∞·ªùng n·∫±m ·ªü th∆∞ m·ª•c g·ªëc c·ªßa project.

### `version`

Ch·ªâ ƒë·ªãnh phi√™n b·∫£n c·ªßa c√∫ ph√°p file Compose m√† b·∫°n ƒëang s·ª≠ d·ª•ng. ƒêi·ªÅu n√†y quan tr·ªçng v√¨ c√°c phi√™n b·∫£n kh√°c nhau c√≥ th·ªÉ h·ªó tr·ª£ c√°c t√≠nh nƒÉng v√† c√∫ ph√°p kh√°c nhau.

```yaml
version:
  "3.8" # Ho·∫∑c "3.9", "3.x". N√™n d√πng phi√™n b·∫£n m·ªõi nh·∫•t ƒë∆∞·ª£c Docker Engine c·ªßa b·∫°n h·ªó tr·ª£.
  # Version "2.x" c≈© h∆°n, "3.x" ph·ªï bi·∫øn hi·ªán nay.
  # Docker Compose V2 (docker compose) kh√¥ng y√™u c·∫ßu version string, nh∆∞ng v·∫´n n√™n c√≥.
```

### `services`

ƒê√¢y l√† n∆°i b·∫°n ƒë·ªãnh nghƒ©a c√°c th√†nh ph·∫ßn (containers) c·ªßa ·ª©ng d·ª•ng. M·ªói key d∆∞·ªõi `services` l√† **t√™n c·ªßa m·ªôt service**. T√™n n√†y quan tr·ªçng v√¨ n√≥ s·∫Ω ƒë∆∞·ª£c Docker Compose s·ª≠ d·ª•ng ƒë·ªÉ tham chi·∫øu gi·ªØa c√°c services (v√≠ d·ª•: service `web` c√≥ th·ªÉ k·∫øt n·ªëi ƒë·∫øn service `db` b·∫±ng hostname `db`).

```yaml
services:
  web:# T√™n service 1 (v√≠ d·ª•:
    frontend ho·∫∑c web server)
    # ... c·∫•u h√¨nh cho service 'web' ...
  api:# T√™n service 2 (v√≠ d·ª•:
    backend application)
    # ... c·∫•u h√¨nh cho service 'api' ...
  db:# T√™n service 3 (v√≠ d·ª•:
    database)
    # ... c·∫•u h√¨nh cho service 'db' ...
```

D∆∞·ªõi m·ªói t√™n service, b·∫°n s·∫Ω khai b√°o c√°c chi ti·∫øt c·∫•u h√¨nh cho n√≥:

### `build` vs `image`

Ch·ªâ ƒë·ªãnh image Docker s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng cho service. B·∫°n c√≥ th·ªÉ d√πng m·ªôt trong hai (ho·∫∑c ƒë√¥i khi c·∫£ hai).

- **`image: <image_name>:<tag>`**:
  S·ª≠ d·ª•ng m·ªôt image ƒë√£ c√≥ s·∫µn t·ª´ Docker Hub ho·∫∑c m·ªôt private registry. Docker Compose s·∫Ω `pull` image n√†y n·∫øu n√≥ ch∆∞a c√≥ ·ªü local.

  ```yaml
  services:
    database:
      image: postgres:14-alpine # L·∫•y image postgres phi√™n b·∫£n 14-alpine
    redis:
      image: redis:7-alpine
  ```

- **`build: <path_to_context>`** ho·∫∑c **`build: { context: <path>, dockerfile: <name>, args: ... }`**:
  Docker Compose s·∫Ω build m·ªôt image t·ª´ Dockerfile.
  - D·∫°ng string ƒë∆°n gi·∫£n:

    ```yaml
    services:
      backend:
        build:
          ./app_folder # ƒê∆∞·ªùng d·∫´n ƒë·∫øn th∆∞ m·ª•c ch·ª©a Dockerfile (build context)
          # Docker Compose s·∫Ω t√¨m file t√™n 'Dockerfile' trong ƒë√≥.
    ```

  - D·∫°ng object ƒë·ªÉ cung c·∫•p th√™m chi ti·∫øt:

    ```yaml
    services:
      backend:
        build:
          context: ./app_folder # Th∆∞ m·ª•c build context.
          dockerfile: Dockerfile.dev # T√™n Dockerfile (n·∫øu kh√°c 'Dockerfile').
          args: # C√°c bi·∫øn --build-arg truy·ªÅn v√†o Dockerfile.
            NODE_VERSION: 18
            APP_ENV: development
          # target: builder          # (T√πy ch·ªçn) Ch·ªâ build m·ªôt stage c·ª• th·ªÉ trong multi-stage Dockerfile.
          # cache_from:              # (T√πy ch·ªçn) S·ª≠ d·ª•ng cache t·ª´ c√°c image kh√°c.
          #   - myapp_cache:latest
    ```

  - B·∫°n c√≥ th·ªÉ d√πng c·∫£ `image` v√† `build`. Docker Compose s·∫Ω build (n·∫øu `build` ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a) v√† tag image ƒë√≥ v·ªõi t√™n b·∫°n cung c·∫•p trong `image`. N·∫øu image ƒë√≥ ƒë√£ t·ªìn t·∫°i v√† b·∫°n kh√¥ng y√™u c·∫ßu build l·∫°i, n√≥ s·∫Ω d√πng image ƒë√≥.

  ```yaml
  services:
    custom_app:
      build: ./my_app_src
      image: myusername/my_custom_app:latest # Sau khi build, image s·∫Ω ƒë∆∞·ª£c tag th·∫ø n√†y
  ```

### `ports`

√Ånh x·∫° ports gi·ªØa m√°y host v√† container. ƒê·ªãnh d·∫°ng: `"HOST_PORT:CONTAINER_PORT"`.
N·∫øu ch·ªâ ghi `"CONTAINER_PORT"`, Docker s·∫Ω t·ª± ƒë·ªông ch·ªçn m·ªôt port ng·∫´u nhi√™n tr√™n host.

```yaml
services:
  frontend:
    image: nginx:latest
    ports:
      - "8080:80" # Map port 8080 c·ªßa host t·ªõi port 80 c·ªßa container frontend.
      - "127.0.0.1:8081:81" # Map port 8081 c·ªßa host (ch·ªâ tr√™n localhost) t·ªõi port 81 c·ªßa container.
      # - "443:443"     # Map port 443 c·ªßa host t·ªõi port 443 c·ªßa container (cho HTTPS).
      # - "9000"        # Expose port 9000 c·ªßa container ra m·ªôt port ng·∫´u nhi√™n tr√™n host.
```

### `volumes`

Mount (g·∫Øn) th∆∞ m·ª•c t·ª´ host v√†o container (bind mount) ho·∫∑c qu·∫£n l√Ω data volumes (named volumes) ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu b·ªÅn b·ªâ.
ƒê·ªãnh d·∫°ng:

- Bind mount: `"HOST_PATH:CONTAINER_PATH"` ho·∫∑c `"HOST_PATH:CONTAINER_PATH:ro"` (read-only).
- Named volume: `"VOLUME_NAME:CONTAINER_PATH"`.
- Anonymous volume: `"CONTAINER_PATH"` (√≠t d√πng tr·ª±c ti·∫øp trong compose, Docker t·ª± qu·∫£n l√Ω).

```yaml
services:
  backend:
    build: ./backend_app
    volumes:
      # Bind mount: thay ƒë·ªïi code ·ªü host -> thay ƒë·ªïi trong container (r·∫•t ti·ªán cho dev)
      - ./backend_app/src:/app/src
      # Named volume: l∆∞u tr·ªØ logs b·ªÅn b·ªâ, t√°ch bi·ªát v·ªõi lifecycle c·ªßa container
      - app_logs:/app/logs
      # Anonymous volume (trong tr∆∞·ªùng h·ª£p n√†y, ƒë·ªÉ node_modules trong container kh√¥ng b·ªã ghi ƒë√® b·ªüi host)
      - /app/node_modules
  database:
    image: postgres:14
    volumes:
      # Named volume: l∆∞u tr·ªØ data c·ªßa DB, ƒë·∫£m b·∫£o d·ªØ li·ªáu kh√¥ng m·∫•t khi container b·ªã x√≥a/t·∫°o l·∫°i
      - db_data:/var/lib/postgresql/data
      # Bind mount: mount file c·∫•u h√¨nh t√πy ch·ªânh
      - ./custom-postgres.conf:/etc/postgresql/postgresql.conf:ro

# Khai b√°o top-level named volumes (n·∫øu kh√¥ng khai b√°o, Docker t·ª± t·∫°o v·ªõi t√™n project_prefix)
volumes:
  db_data:# Docker s·∫Ω t·∫°o v√† qu·∫£n l√Ω volume t√™n l√† 'myproject_db_data' (n·∫øu project t√™n myproject)
    # driver: local # M·∫∑c ƒë·ªãnh
    # external: true # N·∫øu volume ƒë√£ ƒë∆∞·ª£c t·∫°o b√™n ngo√†i Docker Compose
    # name: my_existing_db_data # N·∫øu d√πng external volume v·ªõi t√™n kh√°c
  app_logs:
```

(S·∫Ω n√≥i chi ti·∫øt h∆°n ·ªü ph·∫ßn Docker Volumes)

### `environment`

Thi·∫øt l·∫≠p bi·∫øn m√¥i tr∆∞·ªùng cho container. C√≥ nhi·ªÅu c√°ch khai b√°o:

- D·∫°ng list (m·∫£ng c√°c string `KEY=VALUE`):

  ```yaml
  services:
    api:
      image: my-api-image
      environment:
        - NODE_ENV=development
        - API_KEY=your_api_key_here
        - DATABASE_URL=postgresql://user:pass@db_service_name:5432/mydb
  ```

- D·∫°ng map (dictionary `KEY: VALUE`):

  ```yaml
  services:
    api:
      image: my-api-image
      environment:
        NODE_ENV: development
        API_KEY: your_api_key_here # Gi√° tr·ªã c√≥ th·ªÉ l√† s·ªë, boolean, ho·∫∑c string (n√™n ƒë·ªÉ trong "" n·∫øu c√≥ k√Ω t·ª± ƒë·∫∑c bi·ªát)
        DEBUG_MODE: "true"
  ```

- Tham chi·∫øu t·ª´ file `.env` (file t√™n `.env` n·∫±m c√πng c·∫•p v·ªõi `docker-compose.yml`):
  Docker Compose t·ª± ƒë·ªông ƒë·ªçc file `.env` v√† c√°c bi·∫øn trong ƒë√≥ c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng trong `docker-compose.yml` b·∫±ng c√∫ ph√°p `${VARIABLE_NAME}`.

  ```bash
  # .env file
  POSTGRES_USER=mysecretuser
  POSTGRES_PASSWORD=supersecretpassword123
  WEB_PORT=8000
  ```

  ```yaml
  # docker-compose.yml
  services:
    db:
      image: postgres
      environment:
        POSTGRES_USER: ${POSTGRES_USER} # Tham chi·∫øu t·ª´ .env
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
        # POSTGRES_DB: ${POSTGRES_DB:-default_db_name} # C√∫ ph√°p v·ªõi gi√° tr·ªã m·∫∑c ƒë·ªãnh
    web:
      image: my_web_app
      ports:
        - "${WEB_PORT}:3000"
  ```

### `env_file`

Ch·ªâ ƒë·ªãnh m·ªôt ho·∫∑c nhi·ªÅu file ch·ª©a bi·∫øn m√¥i tr∆∞·ªùng ƒë·ªÉ load v√†o container. M·ªói d√≤ng trong file ph·∫£i theo ƒë·ªãnh d·∫°ng `KEY=VALUE`.

```yaml
services:
  api:
    image: my-api
    env_file:
      - ./common.env # ƒê∆∞·ªùng d·∫´n t·ªõi file env chung
      - ./api.prod.env # File env c·ª• th·ªÉ cho production (ghi ƒë√® gi√° tr·ªã t·ª´ common.env n·∫øu tr√πng key)
      # - .env             # C√≥ th·ªÉ load c·∫£ file .env m·∫∑c ƒë·ªãnh
```

**Th·ª© t·ª± ∆∞u ti√™n c·ªßa bi·∫øn m√¥i tr∆∞·ªùng:**

1. Gi√° tr·ªã ƒë∆∞·ª£c set trong `docker-compose.yml` (ph·∫ßn `environment`).
2. Gi√° tr·ªã ƒë∆∞·ª£c truy·ªÅn qua CLI (`docker-compose run -e KEY=VAL ...`).
3. Gi√° tr·ªã t·ª´ `env_file`.
4. Gi√° tr·ªã t·ª´ file `.env` (n·∫øu d√πng `${VAR}` substitution).
5. Gi√° tr·ªã m·∫∑c ƒë·ªãnh trong image (t·ª´ `ENV` trong Dockerfile).

### `depends_on`

Ch·ªâ ƒë·ªãnh th·ª© t·ª± kh·ªüi ƒë·ªông v√† ph·ª• thu·ªôc gi·ªØa c√°c services. Service A `depends_on` Service B nghƒ©a l√† Docker Compose s·∫Ω ƒë·∫£m b·∫£o Service B ƒë∆∞·ª£c **kh·ªüi ƒë·ªông** _tr∆∞·ªõc_ Service A.
**L∆∞u √Ω quan tr·ªçng:** `depends_on` ch·ªâ ƒë·∫£m b·∫£o container c·ªßa service ph·ª• thu·ªôc ƒë√£ _kh·ªüi ƒë·ªông_, **kh√¥ng ƒë·∫£m b·∫£o** ·ª©ng d·ª•ng b√™n trong container ƒë√≥ ƒë√£ _s·∫µn s√†ng_ ƒë·ªÉ nh·∫≠n k·∫øt n·ªëi (v√≠ d·ª•: database c·∫ßn th·ªùi gian ƒë·ªÉ initialize, web server c·∫ßn th·ªùi gian ƒë·ªÉ load).

```yaml
services:
  api:
    build: ./api_app
    depends_on:
      - db # api s·∫Ω kh·ªüi ƒë·ªông sau khi container 'db' ƒë√£ kh·ªüi ƒë·ªông
      - redis # v√† sau khi container 'redis' ƒë√£ kh·ªüi ƒë·ªông
  db:
    image: postgres
  redis:
    image: redis
```

ƒê·ªÉ x·ª≠ l√Ω vi·ªác "ch·ªù service s·∫µn s√†ng", b·∫°n th∆∞·ªùng c·∫ßn:

- S·ª≠ d·ª•ng `healthcheck` (xem b√™n d∆∞·ªõi). `depends_on` c√≥ th·ªÉ ƒë∆∞·ª£c c·∫•u h√¨nh ƒë·ªÉ ch·ªù service ph·ª• thu·ªôc th√†nh `healthy`.

  ```yaml
  services:
    api:
      build: ./api
      depends_on:
        db:
          condition: service_healthy # Ch·ªù db b√°o healthy
    db:
      image: postgres
      healthcheck: # C·∫•u h√¨nh healthcheck cho db
        test: ["CMD-SHELL", "pg_isready -U postgres"]
        interval: 10s
        timeout: 5s
        retries: 5
  ```

- Ho·∫∑c d√πng c√°c script nh∆∞ `wait-for-it.sh` ho·∫∑c `dockerize` b√™n trong entrypoint/command c·ªßa service ph·ª• thu·ªôc.

### `networks`

Cho ph√©p services k·∫øt n·ªëi v·ªõi nhau.

- **M·∫∑c ƒë·ªãnh:** Docker Compose t·ª± ƒë·ªông t·∫°o m·ªôt **default bridge network** cho t·∫•t c·∫£ services trong file. T√™n network th∆∞·ªùng l√† `<project_name>_default` (project_name l√† t√™n th∆∞ m·ª•c ch·ª©a `docker-compose.yml`). C√°c services trong c√πng network n√†y c√≥ th·ªÉ giao ti·∫øp v·ªõi nhau b·∫±ng t√™n service.
- **Custom networks:** B·∫°n c√≥ th·ªÉ ƒë·ªãnh nghƒ©a network ri√™ng ƒë·ªÉ ki·ªÉm so√°t t·ªët h∆°n.

```yaml
services:
  frontend:
    image: nginx
    networks: # K·∫øt n·ªëi service 'frontend' v√†o network 'front-tier'
      - front-tier
  api:
    image: my-api
    networks: # K·∫øt n·ªëi service 'api' v√†o c·∫£ 'front-tier' v√† 'back-tier'
      - front-tier
      - back-tier
  db:
    image: postgres
    networks: # K·∫øt n·ªëi service 'db' ch·ªâ v√†o 'back-tier' (tƒÉng b·∫£o m·∫≠t)
      - back-tier

# Khai b√°o top-level networks
networks:
  front-tier:
    driver: bridge # M·∫∑c ƒë·ªãnh
  back-tier:
    driver: bridge
    # internal: true # (T√πy ch·ªçn) N·∫øu true, network n√†y kh√¥ng c√≥ k·∫øt n·ªëi ra ngo√†i
```

(S·∫Ω n√≥i chi ti·∫øt h∆°n ·ªü ph·∫ßn Docker Networking)

### `command`

Ghi ƒë√® l·ªánh `CMD` m·∫∑c ƒë·ªãnh ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong Dockerfile c·ªßa image.

```yaml
services:
  worker:
    image: my-worker-image
    command: ["python", "process_queue.py", "--verbose"] # Ghi ƒë√® CMD c·ªßa image
    # command: /app/start-worker.sh # D·∫°ng shell
```

### `entrypoint`

Ghi ƒë√® `ENTRYPOINT` m·∫∑c ƒë·ªãnh ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong Dockerfile c·ªßa image.

```yaml
services:
  app:
    image: my-app-image
    entrypoint: /usr/local/bin/custom-entrypoint.sh
    # entrypoint: ["python", "manage.py"]
    # command: ["runserver", "0.0.0.0:8000"] # command tr·ªü th√†nh ƒë·ªëi s·ªë cho entrypoint m·ªõi
```

**L∆∞u √Ω:** N·∫øu b·∫°n ghi ƒë√® `entrypoint`, `command` s·∫Ω tr·ªü th√†nh ƒë·ªëi s·ªë cho `entrypoint` m·ªõi ƒë√≥. N·∫øu b·∫°n ch·ªâ ghi ƒë√® `command`, n√≥ s·∫Ω l√† ƒë·ªëi s·ªë cho `entrypoint` g·ªëc c·ªßa image (ho·∫∑c l√† l·ªánh ch√≠nh n·∫øu image kh√¥ng c√≥ `entrypoint`).

### `restart`

Ch√≠nh s√°ch kh·ªüi ƒë·ªông l·∫°i container n·∫øu n√≥ b·ªã d·ª´ng ho·∫∑c l·ªói.

- `no`: (M·∫∑c ƒë·ªãnh) Kh√¥ng t·ª± kh·ªüi ƒë·ªông l·∫°i.
- `always`: Lu√¥n kh·ªüi ƒë·ªông l·∫°i container n·∫øu n√≥ d·ª´ng, tr·ª´ khi b·ªã d·ª´ng m·ªôt c√°ch t∆∞·ªùng minh (b·∫±ng `docker stop` ho·∫∑c `docker-compose stop`).
- `on-failure`: Ch·ªâ kh·ªüi ƒë·ªông l·∫°i n·∫øu container tho√°t v·ªõi exit code kh√°c 0 (l·ªói).
  - `on-failure:5`: Kh·ªüi ƒë·ªông l·∫°i t·ªëi ƒëa 5 l·∫ßn.
- `unless-stopped`: Lu√¥n kh·ªüi ƒë·ªông l·∫°i, tr·ª´ khi container b·ªã d·ª´ng t∆∞·ªùng minh b·ªüi ng∆∞·ªùi d√πng ho·∫∑c Docker daemon b·ªã d·ª´ng/kh·ªüi ƒë·ªông l·∫°i.

```yaml
services:
  backend:
    image: my-backend
    restart: always # Lu√¥n c·ªë g·∫Øng ch·∫°y service n√†y
  worker:
    image: my-worker
    restart: on-failure # Kh·ªüi ƒë·ªông l·∫°i n·∫øu worker b·ªã l·ªói
```

### `healthcheck`

C·∫•u h√¨nh ki·ªÉm tra "s·ª©c kh·ªèe" cho service, t∆∞∆°ng t·ª± `HEALTHCHECK` trong Dockerfile. Docker Compose s·∫Ω s·ª≠ d·ª•ng th√¥ng tin n√†y ƒë·ªÉ bi·∫øt service c√≥ ƒëang ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng kh√¥ng. H·ªØu √≠ch khi k·∫øt h·ª£p v·ªõi `depends_on` v√† trong c√°c m√¥i tr∆∞·ªùng orchestration.

```yaml
services:
  db:
    image: postgres:14
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB || exit 1",
        ]
      interval: 15s # Ki·ªÉm tra m·ªói 15 gi√¢y
      timeout: 5s # Ch·ªù t·ªëi ƒëa 5 gi√¢y cho l·ªánh test ho√†n th√†nh
      retries: 3 # Th·ª≠ l·∫°i 3 l·∫ßn n·∫øu th·∫•t b·∫°i
      start_period: 30s # Th·ªùi gian ch·ªù ban ƒë·∫ßu tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu healthcheck (cho DB c√≥ th·ªùi gian kh·ªüi t·∫°o)
    environment:
      POSTGRES_USER: user
      POSTGRES_DB: appdb
```

Tr·∫°ng th√°i healthcheck c√≥ th·ªÉ xem b·∫±ng `docker ps` ho·∫∑c `docker inspect`.

### `expose`

Expose ports c·ªßa container **ch·ªâ cho c√°c services kh√°c trong c√πng network**, kh√¥ng publish ra host.
H·ªØu √≠ch khi b·∫°n c√≥ m·ªôt service n·ªôi b·ªô (v√≠ d·ª•: database) kh√¥ng c·∫ßn truy c·∫≠p t·ª´ b√™n ngo√†i host, nh∆∞ng c√°c service kh√°c trong Compose stack c·∫ßn k·∫øt n·ªëi ƒë·∫øn n√≥.

```yaml
services:
  db:
    image: mysql:8.0
    expose:
      - "3306" # C√°c service kh√°c trong c√πng network c√≥ th·ªÉ k·∫øt n·ªëi ƒë·∫øn 'db:3306'
    # ports: # Kh√¥ng d√πng 'ports' n·∫øu kh√¥ng mu·ªën map ra host
    #  - "3306:3306" # ƒêi·ªÅu n√†y s·∫Ω map ra host
```

Th·ª±c t·∫ø, v·ªõi default network c·ªßa Docker Compose, c√°c service ƒë√£ c√≥ th·ªÉ giao ti·∫øp v·ªõi nhau qua t√™n service v√† port m√† ·ª©ng d·ª•ng trong container l·∫Øng nghe, ngay c·∫£ khi kh√¥ng c√≥ `expose`. `expose` ch·ªß y·∫øu mang t√≠nh t√†i li·ªáu h√≥a ho·∫∑c khi d√πng v·ªõi c√°c network driver kh√°c.

### `extends`

Cho ph√©p chia s·∫ª c·∫•u h√¨nh chung gi·ªØa c√°c services ho·∫∑c gi·ªØa c√°c file Compose kh√°c nhau.

```yaml
# common-services.yml
version: "3.8"
services:
  base_app:
    image: alpine
    environment:
      COMMON_VAR: "shared_value"
    logging:
      driver: "json-file"
      options:
        max-size: "200k"
        max-file: "10"
```

```yaml
# docker-compose.yml
version: "3.8"
services:
  web:
    extends:
      file: common-services.yml # File ch·ª©a c·∫•u h√¨nh chung
      service: base_app # T√™n service trong file ƒë√≥ ƒë·ªÉ k·∫ø th·ª´a
    build: ./web_app
    ports:
      - "80:8000"
    environment: # Ghi ƒë√® ho·∫∑c th√™m bi·∫øn m√¥i tr∆∞·ªùng
      APP_SPECIFIC_VAR: "web_value"
  worker:
    extends:
      file: common-services.yml
      service: base_app
    build: ./worker_app
    environment:
      APP_SPECIFIC_VAR: "worker_value"
```

### `secrets` v√† `configs`

(N√¢ng cao, th∆∞·ªùng d√πng v·ªõi Docker Swarm, nh∆∞ng Compose c≈©ng h·ªó tr·ª£ ·ªü m·ª©c ƒë·ªô n√†o ƒë√≥ cho local dev)

- `secrets`: Qu·∫£n l√Ω d·ªØ li·ªáu nh·∫°y c·∫£m (passwords, API keys). Secrets ƒë∆∞·ª£c mount v√†o container d∆∞·ªõi d·∫°ng file trong `/run/secrets/` (read-only).
- `configs`: Qu·∫£n l√Ω file c·∫•u h√¨nh kh√¥ng nh·∫°y c·∫£m. T∆∞∆°ng t·ª± secrets, ƒë∆∞·ª£c mount v√†o container.

```yaml
version: "3.8"
services:
  myapp:
    image: myapp:latest
    secrets:
      - db_password
    configs:
      - app_config
secrets:
  db_password:
    file: ./db_password.txt # File tr√™n host ch·ª©a password
    # external: true # N·∫øu secret ƒë√£ ƒë∆∞·ª£c t·∫°o trong Docker
configs:
  app_config:
    file: ./app_config.json
    # external: true
```

Trong container, `db_password` s·∫Ω c√≥ t·∫°i `/run/secrets/db_password` v√† `app_config` t·∫°i `/run/configs/app_config` (ho·∫∑c t√™n file g·ªëc n·∫øu d√πng `target`).

### V√≠ d·ª• `docker-compose.yml` ƒë∆°n gi·∫£n

·ª®ng d·ª•ng g·ªìm m·ªôt web app (Node.js) v√† m·ªôt Redis instance.

```yaml
version: "3.8" # Lu√¥n khai b√°o version

services:
  # Service 1: Web application (v√≠ d·ª•: Node.js app)
  web:
    build: ./app # Th∆∞ m·ª•c ch·ª©a Dockerfile c·ªßa app (v√≠ d·ª•: ./app/Dockerfile)
    image: myusername/my-web-app:1.0 # (T√πy ch·ªçn) T√™n image sau khi build
    container_name: my_web_container # (T√πy ch·ªçn) T√™n c·ª• th·ªÉ cho container
    ports:
      - "3000:3000" # Map port 3000 c·ªßa host t·ªõi port 3000 c·ªßa container
    volumes:
      # Mount source code t·ª´ th∆∞ m·ª•c 'app' tr√™n host v√†o '/usr/src/app' trong container
      # Gi√∫p live reload khi code thay ƒë·ªïi (cho m√¥i tr∆∞·ªùng dev)
      - ./app:/usr/src/app
      # Mount anonymous volume cho node_modules ƒë·ªÉ kh√¥ng b·ªã ghi ƒë√® b·ªüi node_modules tr√™n host (n·∫øu c√≥)
      # ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o node_modules ƒë∆∞·ª£c c√†i ƒë·∫∑t b·ªüi 'RUN npm install' trong Dockerfile ƒë∆∞·ª£c s·ª≠ d·ª•ng.
      - /usr/src/app/node_modules
    environment:
      - NODE_ENV=development
      - REDIS_HOST=cache # T√™n service c·ªßa Redis
      - REDIS_PORT=6379
    depends_on: # web app ph·ª• thu·ªôc v√†o Redis
      - cache # ƒê·∫£m b·∫£o 'cache' service kh·ªüi ƒë·ªông tr∆∞·ªõc 'web'
    restart: unless-stopped

  # Service 2: Redis (caching)
  cache: # T√™n service l√† 'cache', web app s·∫Ω k·∫øt n·ªëi t·ªõi Redis qua hostname 'cache'
    image: "redis:7-alpine" # S·ª≠ d·ª•ng image Redis ch√≠nh th·ª©c t·ª´ Docker Hub
    container_name: my_redis_cache
    # ports: # Kh√¥ng nh·∫•t thi·∫øt ph·∫£i expose port Redis ra host n·∫øu ch·ªâ app n·ªôi b·ªô d√πng
    #   - "6379:6379" # V√≠ d·ª• n·∫øu mu·ªën k·∫øt n·ªëi t·ª´ host v√†o Redis n√†y ƒë·ªÉ debug
    volumes:
      - redis_data:/data # S·ª≠ d·ª•ng named volume 'redis_data' ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu Redis b·ªÅn b·ªâ
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

# Khai b√°o named volumes ·ªü top-level
volumes:
  redis_data:# Docker Compose s·∫Ω t·ª± t·∫°o volume n√†y (n·∫øu ch∆∞a c√≥) v·ªõi t√™n project_redis_data
  # driver: local # (M·∫∑c ƒë·ªãnh)
```

**C·∫•u tr√∫c th∆∞ m·ª•c v√≠ d·ª• cho v√≠ d·ª• tr√™n:**

```text
my_project/
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ .env               # (T√πy ch·ªçn) Ch·ª©a c√°c bi·∫øn m√¥i tr∆∞·ªùng chung
‚îî‚îÄ‚îÄ app/
    ‚îú‚îÄ‚îÄ Dockerfile
    ‚îú‚îÄ‚îÄ package.json
    ‚îî‚îÄ‚îÄ server.js
    ‚îî‚îÄ‚îÄ ... (c√°c file kh√°c c·ªßa app)
```

### C√°c l·ªánh Docker Compose c∆° b·∫£n

Ch·∫°y c√°c l·ªánh n√†y t·ª´ th∆∞ m·ª•c ch·ª©a file `docker-compose.yml`.

- `docker-compose up`: Build (n·∫øu `build` ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a v√† image ch∆∞a c√≥ ho·∫∑c c·∫ßn build l·∫°i), t·∫°o v√† kh·ªüi ƒë·ªông t·∫•t c·∫£ c√°c services. Logs c·ªßa t·∫•t c·∫£ services s·∫Ω ƒë∆∞·ª£c stream ra terminal. Nh·∫•n `Ctrl+C` ƒë·ªÉ d·ª´ng.
  - `docker-compose up -d`: Ch·∫°y ·ªü background (detached mode).
  - `docker-compose up --build`: Lu√¥n build l·∫°i images tr∆∞·ªõc khi kh·ªüi ƒë·ªông (k·ªÉ c·∫£ khi image ƒë√£ t·ªìn t·∫°i).
  - `docker-compose up <service_name> [<service_name2>...]`: Ch·ªâ kh·ªüi ƒë·ªông c√°c service ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh (v√† c√°c dependencies c·ªßa ch√∫ng).
- `docker-compose down`: D·ª´ng v√† x√≥a containers, networks, (t√πy ch·ªçn) volumes.
  - `docker-compose down -v`: X√≥a c·∫£ named volumes ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong `volumes` section (v√† anonymous volumes). **C·∫®N TH·∫¨N: M·∫•t d·ªØ li·ªáu trong volumes!**
  - `docker-compose down --rmi all`: X√≥a c·∫£ images ƒë∆∞·ª£c build b·ªüi Compose.
  - `docker-compose down --remove-orphans`: X√≥a c√°c container kh√¥ng c√≤n ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong compose file.
- `docker-compose ps`: Li·ªát k√™ tr·∫°ng th√°i c·ªßa c√°c containers do Compose qu·∫£n l√Ω cho project hi·ªán t·∫°i.
- `docker-compose logs <service_name>`: Xem logs c·ªßa m·ªôt service c·ª• th·ªÉ.
  - `docker-compose logs -f <service_name>`: Theo d√µi logs (live stream).
  - `docker-compose logs --tail=50 <service_name>`: Xem 50 d√≤ng log cu·ªëi.
  - `docker-compose logs`: Xem logs c·ªßa t·∫•t c·∫£ services.
- `docker-compose exec <service_name> <command>`: Ch·∫°y m·ªôt l·ªánh b√™n trong m·ªôt service **ƒëang ch·∫°y**.
  - V√≠ d·ª•: `docker-compose exec web bash` (m·ªü bash shell trong service `web`).
  - V√≠ d·ª•: `docker-compose exec db psql -U myuser -d mydb`
- `docker-compose build <service_name>`: Build (ho·∫∑c rebuild) image cho m·ªôt ho·∫∑c nhi·ªÅu service. N·∫øu kh√¥ng c√≥ `service_name`, build t·∫•t c·∫£.
  - `docker-compose build --no-cache <service_name>`: Build kh√¥ng d√πng cache.
- `docker-compose pull <service_name>`: Pull image m·ªõi nh·∫•t cho m·ªôt ho·∫∑c nhi·ªÅu service (n·∫øu service ƒë√≥ d√πng `image:`).
- `docker-compose start <service_name>`: Kh·ªüi ƒë·ªông c√°c service ƒë√£ ƒë∆∞·ª£c t·∫°o nh∆∞ng ƒëang d·ª´ng.
- `docker-compose stop <service_name>`: D·ª´ng c√°c service ƒëang ch·∫°y m√† kh√¥ng x√≥a ch√∫ng.
- `docker-compose restart <service_name>`: Kh·ªüi ƒë·ªông l·∫°i c√°c service.
- `docker-compose rm <service_name>`: X√≥a c√°c container ƒë√£ d·ª´ng c·ªßa service.
  - `docker-compose rm -f <service_name>`: X√≥a k·ªÉ c·∫£ ƒëang ch·∫°y.
- `docker-compose run --rm <service_name> <command>`: Ch·∫°y m·ªôt container "one-off" cho m·ªôt service (th∆∞·ªùng ƒë·ªÉ ch·∫°y task, test). `--rm` t·ª± x√≥a sau khi ch·∫°y xong. L·ªánh n√†y s·∫Ω kh√¥ng map ports ƒë√£ ƒë·ªãnh nghƒ©a trong `ports` (tr·ª´ khi d√πng `--service-ports`).
  - V√≠ d·ª•: `docker-compose run --rm web npm test`
- `docker-compose config`: Ki·ªÉm tra c√∫ ph√°p file `docker-compose.yml` v√† hi·ªÉn th·ªã c·∫•u h√¨nh ƒë√£ ƒë∆∞·ª£c t√≠nh to√°n (sau khi ƒë√£ x·ª≠ l√Ω `extends`, `env_file`, bi·∫øn m√¥i tr∆∞·ªùng, etc.). R·∫•t h·ªØu √≠ch ƒë·ªÉ debug file compose.
  - `docker-compose -f docker-compose.yml -f docker-compose.override.yml config`: Xem c·∫•u h√¨nh k·∫øt h·ª£p t·ª´ nhi·ªÅu file.
- `docker-compose top <service_name>`: Hi·ªÉn th·ªã c√°c process ƒëang ch·∫°y trong service.

(L∆∞u √Ω: N·∫øu b·∫°n d√πng Docker Compose V2, c√°c l·ªánh s·∫Ω l√† `docker compose ...` thay v√¨ `docker-compose ...`)

## 4. üîó Docker Networking (v·ªõi Compose)

Docker Compose gi√∫p vi·ªác qu·∫£n l√Ω network cho ·ª©ng d·ª•ng ƒëa-container tr·ªü n√™n r·∫•t ƒë∆°n gi·∫£n.

### M·∫°ng m·∫∑c ƒë·ªãnh (Default Bridge Network)

- Khi b·∫°n ch·∫°y `docker-compose up` l·∫ßn ƒë·∫ßu cho m·ªôt project (m·ªôt th∆∞ m·ª•c ch·ª©a `docker-compose.yml`), Compose s·∫Ω t·ª± ƒë·ªông t·∫°o m·ªôt **user-defined bridge network** m·∫∑c ƒë·ªãnh cho ·ª©ng d·ª•ng ƒë√≥.
- T√™n c·ªßa network n√†y th∆∞·ªùng ƒë∆∞·ª£c ƒë·∫∑t theo quy t·∫Øc: `<project_name>_default`.
  - `<project_name>` l√† t√™n c·ªßa th∆∞ m·ª•c ch·ª©a `docker-compose.yml` (v√≠ d·ª•: n·∫øu th∆∞ m·ª•c l√† `my_app`, network s·∫Ω l√† `my_app_default`). B·∫°n c√≥ th·ªÉ ghi ƒë√® t√™n project b·∫±ng option `-p <custom_project_name>` ho·∫∑c bi·∫øn m√¥i tr∆∞·ªùng `COMPOSE_PROJECT_NAME`.
- T·∫•t c·∫£ c√°c `services` ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong file `docker-compose.yml` s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c k·∫øt n·ªëi v√†o network m·∫∑c ƒë·ªãnh n√†y.

### K·∫øt n·ªëi gi·ªØa c√°c services (Service Discovery)

- ƒê√¢y l√† m·ªôt trong nh·ªØng t√≠nh nƒÉng m·∫°nh m·∫Ω nh·∫•t c·ªßa Docker Compose networking.
- B√™n trong network n√†y, c√°c containers (services) c√≥ th·ªÉ **tham chi·∫øu v√† k·∫øt n·ªëi l·∫´n nhau b·∫±ng t√™n service** ƒë√£ ƒë·ªãnh nghƒ©a trong `docker-compose.yml`.
- Docker Engine cung c·∫•p m·ªôt **DNS server n·ªôi b·ªô** cho network n√†y. Khi service `web` mu·ªën k·∫øt n·ªëi ƒë·∫øn service `db`, n√≥ ch·ªâ c·∫ßn d√πng hostname l√† `db`. Docker DNS s·∫Ω t·ª± ƒë·ªông ph√¢n gi·∫£i (resolve) t√™n `db` th√†nh ƒë·ªãa ch·ªâ IP n·ªôi b·ªô c·ªßa container ƒëang ch·∫°y service `db`.
  - V√≠ d·ª•: Trong code c·ªßa service `web` (Node.js), chu·ªói k·∫øt n·ªëi database c√≥ th·ªÉ l√†:
    `const dbUrl = "postgres://user:password@db:5432/mydb";`
    (V·ªõi `db` l√† t√™n service c·ªßa PostgreSQL trong `docker-compose.yml`).
- **B·∫°n kh√¥ng c·∫ßn ph·∫£i `expose` (hay `ports`) port c·ªßa service n·ªôi b·ªô (nh∆∞ database, redis) ra host machine n·∫øu ch·ªâ c√≥ c√°c service kh√°c trong c√πng Compose network c·∫ßn truy c·∫≠p.** ƒêi·ªÅu n√†y gi√∫p tƒÉng c∆∞·ªùng b·∫£o m·∫≠t. Ch·ªâ `ports` nh·ªØng service c·∫ßn truy c·∫≠p t·ª´ b√™n ngo√†i (th∆∞·ªùng l√† web server/frontend).

**S∆° ƒë·ªì minh h·ªça:**

```text
  Host Machine (V√≠ d·ª•: IP 192.168.1.100)
  ---------------------------------------------------------------------------------
  |                                                                               |
  |   Docker Network: myproject_default (VD: 172.18.0.0/16)                       |
  |   -------------------------------------------------------------------------   |
  |   | Service: web (Container A)                                            |   |
  |   | - IP n·ªôi b·ªô: 172.18.0.2                                               |   |
  |   | - Code k·∫øt n·ªëi: connect_to('api:5000'), connect_to('db:5432')         |   |
  |   | - Mapped port: Host:8080 -> Container:80 (Truy c·∫≠p t·ª´ ngo√†i v√†o ƒë√¢y)  |   |
  |   -------------------------------------------------------------------------   |
  |   | Service: api (Container B)                                            |   |
  |   | - IP n·ªôi b·ªô: 172.18.0.3                                               |   |
  |   | - L·∫Øng nghe tr√™n port 5000 (n·ªôi b·ªô)                                   |   |
  |   | - Code k·∫øt n·ªëi: connect_to('db:5432')                                 |   |
  |   -------------------------------------------------------------------------   |
  |   | Service: db (Container C)                                             |   |
  |   | - IP n·ªôi b·ªô: 172.18.0.4                                               |   |
  |   | - L·∫Øng nghe tr√™n port 5432 (n·ªôi b·ªô, kh√¥ng map ra host)                |   |
  |   -------------------------------------------------------------------------   |
  |                                                                               |
  ---------------------------------------------------------------------------------
  Ng∆∞·ªùi d√πng truy c·∫≠p http://localhost:8080 ho·∫∑c http://192.168.1.100:8080
      -> Host OS chuy·ªÉn ƒë·∫øn Container A (web) port 80
          -> Container A (web) c√≥ th·ªÉ g·ªçi Container B (api) qua 'api:5000'
          -> Container B (api) c√≥ th·ªÉ g·ªçi Container C (db) qua 'db:5432'
```

### Custom Networks

B·∫°n c≈©ng c√≥ th·ªÉ ƒë·ªãnh nghƒ©a c√°c network t√πy ch·ªânh trong `docker-compose.yml` ƒë·ªÉ:

- T·∫°o nhi·ªÅu network v√† k·∫øt n·ªëi c√°c service v√†o c√°c network kh√°c nhau ƒë·ªÉ c√¥ l·∫≠p (v√≠ d·ª•: `frontend_net`, `backend_net`).
- K·∫øt n·ªëi v·ªõi c√°c network ƒë√£ t·ªìn t·∫°i b√™n ngo√†i Docker Compose.
- Tinh ch·ªânh driver ho·∫∑c options c·ªßa network.

```yaml
version: "3.8"
services:
  proxy:
    image: nginx
    networks:
      - frontnet # Ch·ªâ k·∫øt n·ªëi v√†o frontnet
    ports:
      - "80:80"
  app:
    build: ./app
    networks:
      - frontnet
      - backnet # K·∫øt n·ªëi v√†o c·∫£ frontnet v√† backnet
  db:
    image: postgres
    networks:
      - backnet # Ch·ªâ k·∫øt n·ªëi v√†o backnet

networks:
  frontnet:
    driver: bridge
    # driver_opts:
    #   com.docker.network.enable_ipv6: "true"
  backnet:
    driver: bridge
    internal: true # Network n√†y kh√¥ng c√≥ k·∫øt n·ªëi ra ngo√†i Internet, tƒÉng b·∫£o m·∫≠t cho DB.
  # existing_net: # K·∫øt n·ªëi t·ªõi network ƒë√£ t·ªìn t·∫°i
  #   external: true
  #   name: my_preexisting_bridge_network
```

Trong v√≠ d·ª• n√†y:

- `proxy` v√† `app` c√≥ th·ªÉ giao ti·∫øp v·ªõi nhau qua `frontnet`.
- `app` v√† `db` c√≥ th·ªÉ giao ti·∫øp v·ªõi nhau qua `backnet`.
- `proxy` kh√¥ng th·ªÉ tr·ª±c ti·∫øp giao ti·∫øp v·ªõi `db`.

## 5. üíæ Docker Volumes (v·ªõi Compose)

### T·∫°i sao c·∫ßn Volumes? (Data Persistence)

- Containers l√† **ephemeral** (t·∫°m th·ªùi, c√≥ t√≠nh ch·∫•t "tho√°ng qua"). Khi m·ªôt container b·ªã x√≥a (`docker rm` ho·∫∑c `docker-compose down`), m·ªçi d·ªØ li·ªáu ƒë∆∞·ª£c ghi v√†o filesystem c·ªßa n√≥ (l·ªõp writable tr√™n c√πng c·ªßa container) s·∫Ω b·ªã **m·∫•t vƒ©nh vi·ªÖn**.
- ƒêi·ªÅu n√†y kh√¥ng th√†nh v·∫•n ƒë·ªÅ v·ªõi c√°c stateless application server, nh∆∞ng l·∫°i l√† th·∫£m h·ªça ƒë·ªëi v·ªõi:
  - **Databases:** D·ªØ li·ªáu l√† t√†i s·∫£n qu√Ω gi√°.
  - **User uploads:** H√¨nh ·∫£nh, t√†i li·ªáu ng∆∞·ªùi d√πng t·∫£i l√™n.
  - **Logs quan tr·ªçng:** C·∫ßn l∆∞u tr·ªØ ƒë·ªÉ ph√¢n t√≠ch, g·ª° l·ªói.
  - **File c·∫•u h√¨nh:** C·∫ßn ƒë∆∞·ª£c duy tr√¨ qua c√°c l·∫ßn kh·ªüi ƒë·ªông l·∫°i container.
- **Volumes** l√† c∆° ch·∫ø c·ªßa Docker ƒë·ªÉ **l∆∞u tr·ªØ d·ªØ li·ªáu m·ªôt c√°ch b·ªÅn b·ªâ (persistently)**, t√°ch bi·ªát kh·ªèi v√≤ng ƒë·ªùi c·ªßa container. D·ªØ li·ªáu trong volume v·∫´n t·ªìn t·∫°i ngay c·∫£ khi container s·ª≠ d·ª•ng n√≥ b·ªã x√≥a v√† t·∫°o l·∫°i.

### C√°c lo·∫°i Volumes trong Docker

Docker h·ªó tr·ª£ m·ªôt s·ªë lo·∫°i volumes/mounts:

1. **Bind Mounts**:

    - **Kh√°i ni·ªám:** Mount (g·∫Øn) m·ªôt file ho·∫∑c th∆∞ m·ª•c t·ª´ **filesystem c·ªßa m√°y host** v√†o m·ªôt ƒë∆∞·ªùng d·∫´n b√™n trong container.
    - **ƒê·∫∑c ƒëi·ªÉm:**
      - R·∫•t ti·ªán cho development: B·∫°n s·ª≠a code tr√™n host, thay ƒë·ªïi ƒë√≥ ƒë∆∞·ª£c ph·∫£n √°nh ngay l·∫≠p t·ª©c v√†o container, h·ªó tr·ª£ live-reloading.
      - D·ªØ li·ªáu ƒë∆∞·ª£c qu·∫£n l√Ω tr·ª±c ti·∫øp tr√™n host.
      - ƒê∆∞·ªùng d·∫´n tr√™n host ph·∫£i t·ªìn t·∫°i (ho·∫∑c Docker s·∫Ω t·∫°o th∆∞ m·ª•c r·ªóng).
      - C√≥ th·ªÉ g√¢y v·∫•n ƒë·ªÅ v·ªÅ performance tr√™n m·ªôt s·ªë OS (macOS, Windows do c∆° ch·∫ø chia s·∫ª file).
      - V·∫•n ƒë·ªÅ v·ªÅ quy·ªÅn (permissions): UID/GID c·ªßa file tr√™n host c√≥ th·ªÉ kh√¥ng kh·ªõp v·ªõi user b√™n trong container, g√¢y l·ªói permission denied.
    - **C√∫ ph√°p trong Compose:** `- ./path/on/host:/path/in/container` ho·∫∑c `- ./path/on/host:/path/in/container:ro` (read-only).

2. **Named Volumes (ho·∫∑c ch·ªâ l√† "Volumes")**:

    - **Kh√°i ni·ªám:** Volumes ƒë∆∞·ª£c **Docker qu·∫£n l√Ω ho√†n to√†n**. D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr·ªØ trong m·ªôt ph·∫ßn ƒë·∫∑c bi·ªát c·ªßa host filesystem do Docker qu·∫£n l√Ω (th∆∞·ªùng l√† `/var/lib/docker/volumes/` tr√™n Linux). B·∫°n kh√¥ng c·∫ßn quan t√¢m ƒë·∫øn v·ªã tr√≠ ch√≠nh x√°c n√†y.
    - **ƒê·∫∑c ƒëi·ªÉm:**
      - **C√°ch ƒë∆∞·ª£c khuy·∫øn kh√≠ch ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu ·ª©ng d·ª•ng b·ªÅn b·ªâ** (VD: database data, logs).
      - ƒê·ªôc l·∫≠p v·ªõi c·∫•u tr√∫c th∆∞ m·ª•c c·ªßa host.
      - D·ªÖ d√†ng backup, migrate, chia s·∫ª gi·ªØa c√°c containers.
      - Performance t·ªët h∆°n bind mounts tr√™n macOS v√† Windows.
      - Docker t·ª± t·∫°o volume n·∫øu ch∆∞a t·ªìn t·∫°i.
      - C√≥ th·ªÉ ƒë∆∞·ª£c qu·∫£n l√Ω b·∫±ng c√°c l·ªánh `docker volume ...` (create, ls, inspect, rm, prune).
    - **C√∫ ph√°p trong Compose:** `- volume_name:/path/in/container`. `volume_name` ƒë∆∞·ª£c khai b√°o ·ªü top-level `volumes:` section.

3. **Anonymous Volumes**:

    - **Kh√°i ni·ªám:** T∆∞∆°ng t·ª± named volumes, nh∆∞ng Docker t·ª± g√°n m·ªôt t√™n ng·∫´u nhi√™n (m·ªôt chu·ªói hash d√†i) cho volume ƒë√≥.
    - **ƒê·∫∑c ƒëi·ªÉm:**
      - Kh√≥ tham chi·∫øu l·∫°i n·∫øu b·∫°n kh√¥ng bi·∫øt t√™n ng·∫´u nhi√™n c·ªßa n√≥.
      - Th∆∞·ªùng ƒë∆∞·ª£c t·∫°o khi b·∫°n ch·ªâ ƒë·ªãnh ƒë∆∞·ªùng d·∫´n container trong `Dockerfile` (`VOLUME /app/data`) ho·∫∑c trong `docker-compose.yml` (`- /app/data`) m√† kh√¥ng ƒë·∫∑t t√™n cho volume.
      - D·ªØ li·ªáu v·∫´n b·ªÅn b·ªâ, nh∆∞ng kh√≥ qu·∫£n l√Ω h∆°n named volumes.
      - S·∫Ω b·ªã x√≥a b·ªüi `docker-compose down -v` ho·∫∑c `docker volume prune`.
    - **C√∫ ph√°p trong Compose (√≠t d√πng tr·ª±c ti·∫øp):** `- /path/in/container`

4. **tmpfs Mounts (Linux only)**:
    - **Kh√°i ni·ªám:** Mount m·ªôt th∆∞ m·ª•c v√†o b·ªô nh·ªõ RAM c·ªßa container, kh√¥ng ghi xu·ªëng ƒëƒ©a.
    - **ƒê·∫∑c ƒëi·ªÉm:**
      - D·ªØ li·ªáu r·∫•t nhanh nh∆∞ng **ho√†n to√†n kh√¥ng b·ªÅn b·ªâ**. M·∫•t khi container d·ª´ng.
      - H·ªØu √≠ch cho vi·ªác l∆∞u tr·ªØ file t·∫°m th·ªùi, nh·∫°y c·∫£m m√† b·∫°n kh√¥ng mu·ªën ghi ra disk.
    - **C√∫ ph√°p trong Compose:**

      ```yaml
      services:
        myservice:
          image: ...
          tmpfs: /app/tmp # Mount /app/tmp v√†o RAM
          # tmpfs:
          #  - /run
          #  - /tmp:size=100m,mode=755 # C√≥ th·ªÉ set size v√† mode
      ```

**Khi n√†o d√πng c√°i n√†o?**

- **Named Volumes:** **∆Øu ti√™n h√†ng ƒë·∫ßu** cho d·ªØ li·ªáu ·ª©ng d·ª•ng c·∫ßn t√≠nh b·ªÅn b·ªâ v√† ƒë·ªôc l·∫≠p v·ªõi host (database data, user uploads, logs quan tr·ªçng, state c·ªßa ·ª©ng d·ª•ng).
- **Bind Mounts:**
  - **Source code trong m√¥i tr∆∞·ªùng development:** ƒê·ªÉ live-reloading, thay ƒë·ªïi code tr√™n host v√† th·∫•y ngay k·∫øt qu·∫£ trong container.
  - **File c·∫•u h√¨nh (config files):** Mount file config t·ª´ host v√†o container ƒë·ªÉ d·ªÖ d√†ng thay ƒë·ªïi m√† kh√¥ng c·∫ßn build l·∫°i image.
  - **Chia s·∫ª file gi·ªØa host v√† container:** V√≠ d·ª•, build artifacts t·ª´ container ra host.
- **Anonymous Volumes:** Tr√°nh s·ª≠ d·ª•ng ch·ªß ƒë·ªông. N·∫øu b·∫°n c·∫ßn d·ªØ li·ªáu b·ªÅn b·ªâ, h√£y d√πng named volume. M·ªôt tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng ph·ªï bi·∫øn l√† `- /app/node_modules` ƒë·ªÉ ngƒÉn bind mount c·ªßa source code ghi ƒë√® l√™n `node_modules` ƒë√£ ƒë∆∞·ª£c `RUN npm install` trong image.
- **tmpfs Mounts:** Cho d·ªØ li·ªáu t·∫°m th·ªùi, kh√¥ng c·∫ßn l∆∞u tr·ªØ, ho·∫∑c d·ªØ li·ªáu nh·∫°y c·∫£m.

### Khai b√°o v√† s·ª≠ d·ª•ng Volumes trong Compose

ƒê√£ ƒë∆∞·ª£c minh h·ªça m·ªôt ph·∫ßn ·ªü tr√™n.

1. **Khai b√°o Named Volumes ·ªü top-level `volumes:` section:**
    ƒê√¢y l√† n∆°i b·∫°n ƒë·ªãnh nghƒ©a c√°c named volumes m√† c√°c services c·ªßa b·∫°n s·∫Ω s·ª≠ d·ª•ng.

    ```yaml
    version: "3.8"
    # ... services ...

    volumes:
      postgres_data: # T√™n volume b·∫°n s·∫Ω tham chi·∫øu trong service
        driver: local # (M·∫∑c ƒë·ªãnh) Driver cho volume, th∆∞·ªùng l√† 'local'
        # external: true # ƒê·∫∑t l√† true n·∫øu volume n√†y ƒë√£ ƒë∆∞·ª£c t·∫°o b√™n ngo√†i compose (b·∫±ng docker volume create)
        # name: my_actual_external_volume_name # T√™n th·ª±c t·∫ø c·ªßa external volume
        # driver_opts:
        #   type: "nfs"
        #   o: "addr=192.168.1.1,rw"
        #   device: ":/path/to/nfs/share"
      mysql_data:
      app_uploads:
    ```

2. **S·ª≠ d·ª•ng Volumes trong `services.<service_name>.volumes`:**
    Trong m·ªói service, b·∫°n khai b√°o c√°c volumes m√† n√≥ s·∫Ω s·ª≠ d·ª•ng.

    ```yaml
    services:
      db_postgres:
        image: postgres:14
        volumes:
          # S·ª≠ d·ª•ng named volume 'postgres_data' ƒë√£ khai b√°o ·ªü top-level
          # Mount v√†o /var/lib/postgresql/data b√™n trong container
          - postgres_data:/var/lib/postgresql/data
          # Bind mount file c·∫•u h√¨nh t·ª´ host
          - ./config/postgres/custom.conf:/etc/postgresql/postgresql.conf:ro
          # Bind mount script kh·ªüi t·∫°o DB (ch·∫°y m·ªôt l·∫ßn)
          - ./init-db.sh:/docker-entrypoint-initdb.d/init-db.sh

      db_mysql:
        image: mysql:8
        volumes:
          - mysql_data:/var/lib/mysql # Named volume

      web_app:
        build: ./my_web_app_src
        volumes:
          # Bind mount source code cho development
          - ./my_web_app_src:/usr/src/app
          # Named volume cho user uploads
          - app_uploads:/usr/src/app/public/uploads
          # Anonymous volume ƒë·ªÉ b·∫£o v·ªá node_modules trong image
          - /usr/src/app/node_modules
    ```

## 6. üõ†Ô∏è Th·ª±c H√†nh: X√¢y D·ª±ng ·ª®ng D·ª•ng Web + Database + Cache v·ªõi Docker Compose

**M·ª•c ti√™u:** T·∫°o m·ªôt ·ª©ng d·ª•ng web Node.js/Express ƒë∆°n gi·∫£n c√≥ c√°c t√≠nh nƒÉng:

1. Hi·ªÉn th·ªã m·ªôt b·ªô ƒë·∫øm s·ªë l∆∞·ª£t truy c·∫≠p trang.
2. L∆∞u tr·ªØ v√† truy xu·∫•t b·ªô ƒë·∫øm n√†y t·ª´ Redis (cache).
3. N·∫øu Redis kh√¥ng c√≥, ho·∫∑c khi kh·ªüi ƒë·ªông l·∫°i, s·∫Ω l·∫•y gi√° tr·ªã t·ª´ PostgreSQL (database) v√† c·∫≠p nh·∫≠t v√†o Redis.
4. Khi trang ƒë∆∞·ª£c truy c·∫≠p, tƒÉng b·ªô ƒë·∫øm, l∆∞u v√†o Redis v√† (b·∫•t ƒë·ªìng b·ªô) v√†o PostgreSQL.

**C·∫•u tr√∫c th∆∞ m·ª•c d·ª± ki·∫øn:**

```text
compose_advanced_practice/
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ .env                 # Ch·ª©a credentials cho DB
‚îî‚îÄ‚îÄ web_app/
    ‚îú‚îÄ‚îÄ Dockerfile
    ‚îú‚îÄ‚îÄ package.json
    ‚îú‚îÄ‚îÄ server.js
    ‚îî‚îÄ‚îÄ init_db.sql      # (T√πy ch·ªçn) Script SQL ƒë·ªÉ kh·ªüi t·∫°o b·∫£ng
```

**1. `web_app/package.json`:**
(Ch·∫°y `cd web_app && npm init -y && npm install express redis pg`)

```json
{
  "name": "web-app-db-redis",
  "version": "1.0.0",
  "description": "Node.js app with Postgres and Redis",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "dependencies": {
    "express": "^4.18.1",
    "redis": "^4.6.7", // Redis client v4 s·ª≠ d·ª•ng Promises
    "pg": "^8.11.0" // PostgreSQL client
  },
  "devDependencies": {
    "nodemon": "^2.0.15" // (T√πy ch·ªçn) Cho live reload khi dev
  }
}
```

**2. `web_app/server.js`:**

```javascript
// web_app/server.js
const express = require("express");
const redis = require("redis");
const { Pool } = require("pg");

const app = express();
const PORT = process.env.PORT || 3000;

// --- C·∫•u h√¨nh Redis Client (v4) ---
const redisClient = redis.createClient({
  socket: {
    host: process.env.REDIS_HOST || "localhost", // S·∫Ω l√† 'cache_service' t·ª´ docker-compose
    port: process.env.REDIS_PORT || 6379,
  },
});

redisClient.on("error", (err) => console.error("Redis Client Error", err));
(async () => {
  await redisClient.connect();
  console.log("Connected to Redis!");
})();

// --- C·∫•u h√¨nh PostgreSQL Client ---
const pgPool = new Pool({
  user: process.env.POSTGRES_USER,
  host: process.env.POSTGRES_HOST, // S·∫Ω l√† 'db_service' t·ª´ docker-compose
  database: process.env.POSTGRES_DB,
  password: process.env.POSTGRES_PASSWORD,
  port: process.env.POSTGRES_PORT || 5432,
});

pgPool.on("connect", () => console.log("Connected to PostgreSQL!"));
pgPool.on("error", (err) => console.error("PostgreSQL Client Error", err));

// --- H√†m kh·ªüi t·∫°o b·∫£ng n·∫øu ch∆∞a c√≥ ---
async function initializeDatabase() {
  try {
    await pgPool.query(`
      CREATE TABLE IF NOT EXISTS visit_counts (
        id VARCHAR(255) PRIMARY KEY DEFAULT 'page_visits',
        count INTEGER NOT NULL DEFAULT 0
      );
    `);
    // Ch√®n d√≤ng m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥
    await pgPool.query(`
      INSERT INTO visit_counts (id, count)
      VALUES ('page_visits', 0)
      ON CONFLICT (id) DO NOTHING;
    `);
    console.log("Database table 'visit_counts' initialized or already exists.");
  } catch (err) {
    console.error("Error initializing database table:", err);
  }
}

// --- Logic ch√≠nh ---
const COUNTER_KEY = "page_visits_counter";

app.get("/", async (req, res) => {
  let visits = 0;
  try {
    // 1. Th·ª≠ l·∫•y t·ª´ Redis
    const redisVisits = await redisClient.get(COUNTER_KEY);

    if (redisVisits !== null) {
      visits = parseInt(redisVisits, 10);
    } else {
      // 2. N·∫øu kh√¥ng c√≥ trong Redis, l·∫•y t·ª´ DB
      const dbResult = await pgPool.query(
        "SELECT count FROM visit_counts WHERE id = 'page_visits'"
      );
      if (dbResult.rows.length > 0) {
        visits = dbResult.rows[0].count;
      } else {
        // Fallback n·∫øu DB c≈©ng ch∆∞a c√≥ (d√π init_db n√™n x·ª≠ l√Ω vi·ªác n√†y)
        visits = 0;
        await pgPool.query(
          "INSERT INTO visit_counts (id, count) VALUES ('page_visits', 0) ON CONFLICT (id) DO UPDATE SET count = 0"
        );
      }
      // C·∫≠p nh·∫≠t v√†o Redis
      await redisClient.set(COUNTER_KEY, visits);
      console.log("Loaded visits from DB to Redis:", visits);
    }

    // 3. TƒÉng b·ªô ƒë·∫øm
    visits++;

    // 4. L∆∞u l·∫°i v√†o Redis
    await redisClient.set(COUNTER_KEY, visits);

    // 5. (B·∫•t ƒë·ªìng b·ªô) L∆∞u v√†o DB
    pgPool
      .query("UPDATE visit_counts SET count = $1 WHERE id = 'page_visits'", [
        visits,
      ])
      .catch((err) => console.error("Error updating DB:", err));

    res.send(
      `<h1>Hello Docker Universe!</h1><p>This page has been visited ${visits} times.</p><p>Counter updated in Redis and (eventually) PostgreSQL.</p>`
    );
  } catch (error) {
    console.error("Error processing request:", error);
    res.status(500).send("Oops, something went wrong! Check server logs.");
  }
});

// --- Kh·ªüi ƒë·ªông server ---
app.listen(PORT, async () => {
  await initializeDatabase(); // ƒê·∫£m b·∫£o b·∫£ng t·ªìn t·∫°i khi server kh·ªüi ƒë·ªông
  console.log(`Web app listening on port ${PORT}`);
});
```

**3. `web_app/Dockerfile`:**

```dockerfile
FROM node:18-alpine

WORKDIR /usr/src/app

# Copy package.json v√† package-lock.json (n·∫øu c√≥)
COPY package*.json ./

# C√†i ƒë·∫∑t dependencies (bao g·ªìm devDependencies n·∫øu kh√¥ng c√≥ --production)
# Trong m√¥i tr∆∞·ªùng dev, c√≥ th·ªÉ mu·ªën c·∫£ devDependencies (nh∆∞ nodemon)
RUN npm install

# Copy to√†n b·ªô source code
COPY . .

# Expose port m√† ·ª©ng d·ª•ng ch·∫°y
EXPOSE 3000

# L·ªánh ƒë·ªÉ ch·∫°y ·ª©ng d·ª•ng (s·ª≠ d·ª•ng nodemon n·∫øu c√≥ trong devDependencies v√† l√† m√¥i tr∆∞·ªùng dev)
# B·∫°n c√≥ th·ªÉ truy·ªÅn bi·∫øn m√¥i tr∆∞·ªùng NODE_ENV t·ª´ docker-compose.yml
# CMD if [ "$NODE_ENV" = "development" ]; then npm run dev; else npm start; fi
# Ho·∫∑c ƒë∆°n gi·∫£n h∆°n:
CMD [ "npm", "start" ]
```

**4. `web_app/init_db.sql` (T√πy ch·ªçn, n·∫øu b·∫°n mu·ªën Postgres t·ª± ch·∫°y script n√†y):**

```sql
-- web_app/init_db.sql
-- Script n√†y kh√¥ng c·∫ßn thi·∫øt n·∫øu server.js t·ª± t·∫°o b·∫£ng, nh∆∞ng l√† m·ªôt c√°ch kh√°c.
CREATE TABLE IF NOT EXISTS visit_counts (
  id VARCHAR(255) PRIMARY KEY DEFAULT 'page_visits',
  count INTEGER NOT NULL DEFAULT 0
);

INSERT INTO visit_counts (id, count)
VALUES ('page_visits', 0)
ON CONFLICT (id) DO NOTHING;

-- B·∫°n c√≥ th·ªÉ th√™m c√°c b·∫£ng kh√°c ·ªü ƒë√¢y
-- CREATE TABLE IF NOT EXISTS users (...);
```

**5. `.env` file (trong th∆∞ m·ª•c `compose_advanced_practice`):**

```env
# .env
# Credentials cho PostgreSQL
POSTGRES_USER=dockeruser
POSTGRES_PASSWORD=dockerpass
POSTGRES_DB=appdb
POSTGRES_PORT=5432 # Port b√™n trong container DB

# Config cho App
NODE_ENV=development
PORT=3000 # Port app l·∫Øng nghe b√™n trong container

# Config cho Redis (kh√¥ng c·∫ßn credentials cho v√≠ d·ª• n√†y)
REDIS_HOST=cache_service # T√™n service c·ªßa Redis trong docker-compose
REDIS_PORT=6379
```

**6. `docker-compose.yml` (trong th∆∞ m·ª•c `compose_advanced_practice`):**

```yaml
version: "3.8"

services:
  # Web Application Service
  app:
    build: ./web_app
    container_name: node_app_service
    ports:
      - "${PORT}:${PORT}" # S·ª≠ d·ª•ng bi·∫øn PORT t·ª´ .env cho host, map t·ªõi PORT trong container
    volumes:
      - ./web_app:/usr/src/app # Mount source code cho live reload
      - /usr/src/app/node_modules # Anonymous volume ƒë·ªÉ gi·ªØ node_modules c·ªßa image
    environment: # Truy·ªÅn c√°c bi·∫øn m√¥i tr∆∞·ªùng c·∫ßn thi·∫øt cho app
      NODE_ENV: ${NODE_ENV}
      PORT: ${PORT}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_HOST: db_service # T√™n service c·ªßa PostgreSQL
      POSTGRES_PORT: ${POSTGRES_PORT} # Port PostgreSQL l·∫Øng nghe B√äN TRONG network
      REDIS_HOST: ${REDIS_HOST} # T√™n service c·ªßa Redis
      REDIS_PORT: ${REDIS_PORT}
    depends_on: # App ph·ª• thu·ªôc v√†o db v√† cache
      db_service:
        condition: service_healthy # Ch·ªù db_service b√°o healthy
      cache_service:
        condition: service_healthy # Ch·ªù cache_service b√°o healthy
    restart: unless-stopped

  # PostgreSQL Database Service
  db_service:
    image: postgres:14-alpine
    container_name: postgres_db_service
    environment: # C√°c bi·∫øn n√†y ƒë∆∞·ª£c image postgres s·ª≠ d·ª•ng ƒë·ªÉ kh·ªüi t·∫°o DB
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_app_data:/var/lib/postgresql/data # Named volume cho d·ªØ li·ªáu Postgres
      # - ./web_app/init_db.sql:/docker-entrypoint-initdb.d/init.sql # (T√πy ch·ªçn) Mount script SQL kh·ªüi t·∫°o
    ports: # Ch·ªâ map ra host n·∫øu b·∫°n c·∫ßn truy c·∫≠p DB t·ª´ b√™n ngo√†i (VD: b·∫±ng pgAdmin)
      - "5433:5432" # Host port 5433 -> Container port 5432 (tr√°nh xung ƒë·ªôt n·∫øu host ƒë√£ c√≥ Postgres ch·∫°y ·ªü 5432)
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB -q || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s # Cho Postgres th·ªùi gian kh·ªüi t·∫°o
    restart: always

  # Redis Cache Service
  cache_service:
    image: redis:7-alpine
    container_name: redis_cache_service
    volumes:
      - redis_app_data:/data # Named volume cho d·ªØ li·ªáu Redis (n·∫øu Redis ƒë∆∞·ª£c c·∫•u h√¨nh ƒë·ªÉ persist)
    # ports: # Ch·ªâ map ra host n·∫øu b·∫°n c·∫ßn truy c·∫≠p Redis t·ª´ b√™n ngo√†i (VD: b·∫±ng redis-cli t·ª´ host)
    #   - "6380:6379" # Host port 6380 -> Container port 6379
    healthcheck:
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "6379", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: always

# Top-level named volumes
volumes:
  postgres_app_data:
  redis_app_data:
```

**Ch·∫°y ·ª©ng d·ª•ng:**

1. **Chu·∫©n b·ªã:**
    - ƒê·∫£m b·∫£o b·∫°n ƒë√£ t·∫°o c√°c file v√† th∆∞ m·ª•c nh∆∞ c·∫•u tr√∫c tr√™n.
    - Trong th∆∞ m·ª•c `web_app`, ch·∫°y `npm init -y` v√† `npm install express redis pg nodemon` (n·∫øu b·∫°n mu·ªën `nodemon`).
2. **Kh·ªüi ƒë·ªông:**
    M·ªü terminal trong th∆∞ m·ª•c `compose_advanced_practice` (ch·ª©a `docker-compose.yml`).
    Ch·∫°y: `docker-compose up --build` (ho·∫∑c `docker compose up --build` cho V2).
    `-d` ƒë·ªÉ ch·∫°y ·ªü background: `docker-compose up -d --build`.
3. **Ki·ªÉm tra:**
    - M·ªü tr√¨nh duy·ªát v√† truy c·∫≠p `http://localhost:3000` (ho·∫∑c port b·∫°n ƒë·∫∑t trong `.env`).
    - M·ªói l·∫ßn refresh, b·ªô ƒë·∫øm s·∫Ω tƒÉng.
    - Ki·ªÉm tra logs: `docker-compose logs app`, `docker-compose logs db_service`, `docker-compose logs cache_service`.
    - (N·∫øu map port DB/Redis ra host) B·∫°n c√≥ th·ªÉ k·∫øt n·ªëi t·ªõi PostgreSQL (qua port 5433) ho·∫∑c Redis (qua port 6380) t·ª´ m√°y host ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu.
4. **Th·ª≠ nghi·ªám t√≠nh b·ªÅn b·ªâ v√† cache:**
    - Refresh trang v√†i l·∫ßn.
    - D·ª´ng v√† kh·ªüi ƒë·ªông l·∫°i to√†n b·ªô stack: `docker-compose down` (KH√îNG d√πng `-v` n·∫øu mu·ªën gi·ªØ data DB) r·ªìi `docker-compose up`. B·ªô ƒë·∫øm n√™n ƒë∆∞·ª£c l·∫•y t·ª´ DB v√† ti·∫øp t·ª•c.
    - N·∫øu b·∫°n d·ª´ng Redis (`docker-compose stop cache_service`), ·ª©ng d·ª•ng v·∫´n n√™n ho·∫°t ƒë·ªông (l·∫•y t·ª´ DB). Kh·ªüi ƒë·ªông l·∫°i Redis (`docker-compose start cache_service`), n√≥ s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t l·∫°i.
5. **D·ªçn d·∫πp:**
    `docker-compose down`
    ƒê·ªÉ x√≥a c·∫£ volumes (m·∫•t d·ªØ li·ªáu DB v√† Redis): `docker-compose down -v`

## 7. ‚ú® Best Practices & M·∫πo

### Dockerfile Best Practices (Nh·∫Øc l·∫°i v√† b·ªï sung)

- **S·ª≠ d·ª•ng base image ch√≠nh th·ª©c v√† nh·ªè g·ªçn (official & slim images):** ∆Øu ti√™n c√°c image `alpine` (VD: `node:18-alpine`, `python:3.10-alpine`) v√¨ ch√∫ng nh·ªè, gi·∫£m attack surface.
- **S·ª≠ d·ª•ng tag c·ª• th·ªÉ cho base image:** Tr√°nh `latest` (VD: `node:18.17.0-alpine` thay v√¨ `node:alpine` ho·∫∑c `node:latest`) ƒë·ªÉ ƒë·∫£m b·∫£o build nh·∫•t qu√°n v√† tr√°nh l·ªói b·∫•t ng·ªù khi `latest` thay ƒë·ªïi.
- **T·ªëi ∆∞u h√≥a th·ª© t·ª± l·ªánh ƒë·ªÉ t·∫≠n d·ª•ng caching:** ƒê·∫∑t c√°c l·ªánh √≠t thay ƒë·ªïi l√™n tr√™n (VD: `FROM`, `ENV`, `RUN apt-get install ...`). `COPY package.json` v√† `RUN npm install` n√™n ƒë·∫∑t tr∆∞·ªõc `COPY . .` (v√¨ dependencies √≠t thay ƒë·ªïi h∆°n source code).
- **Gi·∫£m s·ªë l∆∞·ª£ng layers:** M·ªói `RUN`, `COPY`, `ADD` t·∫°o m·ªôt layer. K·∫øt h·ª£p c√°c l·ªánh `RUN` li√™n quan b·∫±ng `&&` v√† `\` (n·ªëi d√≤ng) ƒë·ªÉ gi·∫£m s·ªë layer, gi√∫p image nh·ªè h∆°n v√† build nhanh h∆°n.

  ```dockerfile
  RUN apt-get update && apt-get install -y \
      package1 \
      package2 \
      package3 \
   && rm -rf /var/lib/apt/lists/* # X√≥a cache c·ªßa package manager
  ```

- **S·ª≠ d·ª•ng `.dockerignore` hi·ªáu qu·∫£:** Lo·∫°i b·ªè c√°c file/folder kh√¥ng c·∫ßn thi·∫øt (VD: `.git`, `node_modules` c·ªßa host, `*.log`, `*.tmp`, `Dockerfile` itself) kh·ªèi build context.
- **Ch·∫°y ·ª©ng d·ª•ng v·ªõi user kh√¥ng ph·∫£i root (non-root user):** TƒÉng c∆∞·ªùng b·∫£o m·∫≠t. T·∫°o user/group b·∫±ng `RUN` v√† chuy·ªÉn sang user ƒë√≥ b·∫±ng `USER`.

  ```dockerfile
  RUN addgroup -S appgroup && adduser -S appuser -G appgroup
  USER appuser
  ```

- **S·ª≠ d·ª•ng multi-stage builds:** ƒê·ªÉ t·∫°o image production nh·ªè g·ªçn, ch·ªâ ch·ª©a runtime v√† artifact ƒë√£ bi√™n d·ªãch, kh√¥ng ch·ª©a build tools, source code g·ªëc, hay dev dependencies.

  ```dockerfile
  # Stage 1: Build stage (Node.js v√≠ d·ª•)
  FROM node:18-alpine AS builder
  WORKDIR /app
  COPY package*.json ./
  RUN npm ci --only=production
  COPY . .
  RUN npm run build # Gi·∫£ s·ª≠ c√≥ script build (VD: transpile TS, bundle frontend)

  # Stage 2: Production stage
  FROM node:18-alpine
  WORKDIR /app
  # (T√πy ch·ªçn) T·∫°o non-root user
  RUN addgroup -S appgroup && adduser -S appuser -G appgroup

  # Copy ch·ªâ nh·ªØng th·ª© c·∫ßn thi·∫øt t·ª´ builder stage
  COPY --from=builder /app/node_modules ./node_modules
  COPY --from=builder /app/dist ./dist  # Ho·∫∑c ./build t√πy v√†o output c·ªßa b·∫°n
  COPY --from=builder /app/package.json ./package.json # C√≥ th·ªÉ c·∫ßn cho runtime

  # (T√πy ch·ªçn) Chuy·ªÉn user
  # USER appuser

  EXPOSE 3000
  CMD [ "node", "dist/server.js" ] # Ch·∫°y t·ª´ artifact ƒë√£ build
  ```

- **`COPY` thay v√¨ `ADD` cho file/folder c·ª•c b·ªô:** `COPY` r√µ r√†ng h∆°n. Ch·ªâ d√πng `ADD` khi b·∫°n c·∫ßn t√≠nh nƒÉng t·ª± ƒë·ªông gi·∫£i n√©n tarball ho·∫∑c t·∫£i file t·ª´ URL (d√π t·∫£i URL trong Dockerfile c≈©ng kh√¥ng ph·∫£i l√† best practice l·∫Øm, c√≥ th·ªÉ l√†m ·ªü entrypoint script).
- **Hi·ªÉu r√µ `CMD` v√† `ENTRYPOINT`:**
  - `ENTRYPOINT` ƒë·ªãnh nghƒ©a executable ch√≠nh.
  - `CMD` cung c·∫•p tham s·ªë m·∫∑c ƒë·ªãnh cho `ENTRYPOINT` ho·∫∑c l√† l·ªánh m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ `ENTRYPOINT`.
  - ∆Øu ti√™n exec form (`["executable", "param1"]`).
- **Kh√¥ng l∆∞u tr·ªØ secrets trong image:** D√πng bi·∫øn m√¥i tr∆∞·ªùng truy·ªÅn v√†o l√∫c runtime, ho·∫∑c Docker secrets/configs, ho·∫∑c c√°c gi·∫£i ph√°p qu·∫£n l√Ω secret chuy√™n d·ª•ng (HashiCorp Vault).
- **D·ªçn d·∫πp sau khi c√†i ƒë·∫∑t:** X√≥a cache c·ªßa package manager (`rm -rf /var/lib/apt/lists/*`, `apk add --no-cache ...`), file t·∫°m, source code ƒë√£ bi√™n d·ªãch kh√¥ng c·∫ßn thi·∫øt trong c√πng m·ªôt `RUN` layer.

### Docker Compose Best Practices

- **S·ª≠ d·ª•ng `version: "3.x"`** (phi√™n b·∫£n m·ªõi nh·∫•t m√† Docker Engine c·ªßa b·∫°n h·ªó tr·ª£, th∆∞·ªùng l√† 3.8 ho·∫∑c 3.9).
- **ƒê·∫∑t t√™n services r√µ r√†ng, d·ªÖ hi·ªÉu.** T√™n service c≈©ng l√† hostname cho service discovery.
- **S·ª≠ d·ª•ng bi·∫øn m√¥i tr∆∞·ªùng v√† file `.env`:**
  - ƒê·ªÉ c·∫•u h√¨nh c√°c th√¥ng s·ªë thay ƒë·ªïi gi·ªØa c√°c m√¥i tr∆∞·ªùng (dev, test, prod) nh∆∞ database credentials, API keys, ports.
  - **Kh√¥ng hardcode credentials** tr·ª±c ti·∫øp trong `docker-compose.yml`.
  - File `.env` ·ªü th∆∞ m·ª•c g·ªëc c·ªßa project ƒë∆∞·ª£c Docker Compose t·ª± ƒë·ªông load.
- **S·ª≠ d·ª•ng `depends_on` v√† `healthcheck`:**
  - `depends_on` ƒë·ªÉ ki·ªÉm so√°t th·ª© t·ª± kh·ªüi ƒë·ªông.
  - K·∫øt h·ª£p `depends_on` v·ªõi `condition: service_healthy` v√† `healthcheck` trong service ph·ª• thu·ªôc ƒë·ªÉ ƒë·∫£m b·∫£o service ƒë√≥ th·ª±c s·ª± s·∫µn s√†ng tr∆∞·ªõc khi service kh√°c b·∫Øt ƒë·∫ßu.
- **Ch·ªâ `ports` (map ra host) nh·ªØng service th·ª±c s·ª± c·∫ßn truy c·∫≠p t·ª´ b√™n ngo√†i.** C√°c service giao ti·∫øp n·ªôi b·ªô qua network c·ªßa Compose kh√¥ng c·∫ßn map port ra host.
- **S·ª≠ d·ª•ng `volumes` cho persistent data (named volumes) v√† source code khi dev (bind mounts).**
  - ƒê·∫∑t t√™n r√µ r√†ng cho named volumes.
  - C·∫©n th·∫≠n v·ªõi `docker-compose down -v` (s·∫Ω x√≥a named volumes).
- **T√°ch bi·ªát c·∫•u h√¨nh cho c√°c m√¥i tr∆∞·ªùng (dev, staging, prod):**
  - S·ª≠ d·ª•ng nhi·ªÅu file Compose: `docker-compose.yml` (chung), `docker-compose.override.yml` (cho dev, ƒë∆∞·ª£c load t·ª± ƒë·ªông), `docker-compose.prod.yml`, `docker-compose.test.yml`.
  - S·ª≠ d·ª•ng option `-f` ƒë·ªÉ ch·ªâ ƒë·ªãnh c√°c file compose c·∫ßn load:
    `docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d`
  - `docker-compose.override.yml` l√† file m·∫∑c ƒë·ªãnh ƒë∆∞·ª£c load sau `docker-compose.yml` n·∫øu n√≥ t·ªìn t·∫°i, r·∫•t ti·ªán ƒë·ªÉ ghi ƒë√® c·∫•u h√¨nh cho m√¥i tr∆∞·ªùng dev (VD: th√™m bind mount cho source code, map port debug).
- **S·ª≠ d·ª•ng `restart` policies ph√π h·ª£p:** `always` ho·∫∑c `unless-stopped` cho c√°c service quan tr·ªçng (DB, web server), `on-failure` cho workers.
- **ƒê·∫∑t `container_name` (t√πy ch·ªçn):** Gi√∫p container c√≥ t√™n c·ªë ƒë·ªãnh, d·ªÖ tham chi·∫øu b·∫±ng `docker` CLI, nh∆∞ng c√≥ th·ªÉ g√¢y xung ƒë·ªôt n·∫øu b·∫°n ch·∫°y nhi·ªÅu project Compose gi·ªëng h·ªát nhau. M·∫∑c ƒë·ªãnh Compose s·∫Ω t·∫°o t√™n d·∫°ng `<project>_<service>_<instance_number>`.
- **S·ª≠ d·ª•ng `profiles` (Compose v2.1+):** Cho ph√©p ƒë·ªãnh nghƒ©a c√°c nh√≥m services t√πy ch·ªçn, ch·ªâ ƒë∆∞·ª£c kh·ªüi ƒë·ªông khi profile ƒë√≥ ƒë∆∞·ª£c k√≠ch ho·∫°t. H·ªØu √≠ch ƒë·ªÉ b·∫≠t/t·∫Øt c√°c service kh√¥ng c·ªët l√µi (VD: tool debug, service th·ª≠ nghi·ªám).

  ```yaml
  services:
    web:# Lu√¥n ch·∫°y
      # ...
    db:# Lu√¥n ch·∫°y
      # ...
    mailhog: # Service ƒë·ªÉ test email, ch·ªâ ch·∫°y khi profile 'dev-tools' ƒë∆∞·ª£c active
      image: mailhog/mailhog
      profiles: ["dev-tools"]
      ports:
        - "1025:1025" # SMTP
        - "8025:8025" # Web UI
  # Ch·∫°y: docker-compose --profile dev-tools up
  ```

### S·ª≠ d·ª•ng `.dockerignore`

Nh·∫Øc l·∫°i t·ª´ ph·∫ßn Dockerfile: file `.dockerignore` (ƒë·∫∑t c√πng c·∫•p v·ªõi `Dockerfile`) ch·ªâ ƒë·ªãnh c√°c file/folder s·∫Ω **KH√îNG** ƒë∆∞·ª£c g·ª≠i t·ªõi Docker daemon khi build image (trong `build context`).
V√≠ d·ª• `.dockerignore` cho m·ªôt project Node.js:

```text
# Logs and temporary files
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pids
*.pid
*.seed
*.pid.lock

# Build artifacts
dist
build
coverage
.nyc_output

# Dependency directories
node_modules/
jspm_packages/

# Git
.git
.gitignore
.gitattributes

# Editor / OS specific
.vscode/
.idea/
*.swp
*~
.DS_Store
Thumbs.db

# Docker specific
Dockerfile # Kh√¥ng c·∫ßn copy ch√≠nh Dockerfile v√†o image
.dockerignore

# Environment files (n√™n ƒë∆∞·ª£c qu·∫£n l√Ω b√™n ngo√†i image)
.env
*.env.local
*.env.development.local
*.env.test.local
*.env.production.local

# Optional: Local config files not for image
config/local.json
```

ƒêi·ªÅu n√†y gi√∫p:

- **Gi·∫£m k√≠ch th∆∞·ªõc build context** -> build nhanh h∆°n.
- **Tr√°nh v√¥ t√¨nh copy file nh·∫°y c·∫£m** (nh∆∞ `.env` ch·ª©a credentials) v√†o image.
- **Tr√°nh ghi ƒë√® file/folder** ƒë√£ ƒë∆∞·ª£c t·∫°o b·ªüi c√°c `RUN` command trong Dockerfile (VD: `node_modules` trong image kh√¥ng b·ªã ghi ƒë√® b·ªüi `node_modules` tr√™n host n·∫øu `COPY . .` ƒë∆∞·ª£c d√πng).
- **T·ªëi ∆∞u h√≥a Docker build cache:** N·∫øu file kh√¥ng c·∫ßn thi·∫øt thay ƒë·ªïi, n√≥ s·∫Ω kh√¥ng l√†m m·∫•t cache c·ªßa l·ªánh `COPY`.

### Qu·∫£n l√Ω m√¥i tr∆∞·ªùng (Dev, Staging, Prod)

S·ª≠ d·ª•ng k·∫øt h·ª£p c√°c file `docker-compose.yml`, `docker-compose.override.yml`, v√† c√°c file d√†nh ri√™ng cho m√¥i tr∆∞·ªùng (v√≠ d·ª•: `docker-compose.prod.yml`), c√πng v·ªõi bi·∫øn m√¥i tr∆∞·ªùng.

- **`docker-compose.yml` (Base):** Ch·ª©a c·∫•u h√¨nh chung, ·ªïn ƒë·ªãnh cho t·∫•t c·∫£ c√°c m√¥i tr∆∞·ªùng. Th∆∞·ªùng l√† c·∫•u h√¨nh g·∫ßn gi·ªëng production nh·∫•t nh∆∞ng kh√¥ng ch·ª©a secrets.
- **`docker-compose.override.yml` (Dev default):**
  - T·ª± ƒë·ªông ƒë∆∞·ª£c load b·ªüi `docker-compose up` n·∫øu t·ªìn t·∫°i.
  - Ghi ƒë√®/b·ªï sung c·∫•u h√¨nh cho m√¥i tr∆∞·ªùng development.
  - V√≠ d·ª•:
    - Mount source code b·∫±ng bind volumes ƒë·ªÉ live reload.
    - Map th√™m ports (VD: port debug cho Node.js).
    - S·ª≠ d·ª•ng image c√≥ tool dev (VD: `node:18-alpine` thay v√¨ `node:18-slim`).
    - Thay ƒë·ªïi `command` ƒë·ªÉ ch·∫°y v·ªõi `nodemon` ho·∫∑c tool t∆∞∆°ng t·ª±.
    - Th√™m c√°c service ch·ªâ d√πng cho dev (VD: `mailhog`, `adminer`).
- **`docker-compose.prod.yml` (Production):**
  - Ch·ª©a c·∫•u h√¨nh ri√™ng cho production.
  - V√≠ d·ª•:
    - Kh√¥ng mount source code.
    - S·ª≠ d·ª•ng image ƒë√£ ƒë∆∞·ª£c t·ªëi ∆∞u cho production (VD: t·ª´ multi-stage build).
    - C·∫•u h√¨nh `restart: always`.
    - C·∫•u h√¨nh logging ph√π h·ª£p cho production.
    - S·ª≠ d·ª•ng bi·∫øn m√¥i tr∆∞·ªùng ho·∫∑c secrets cho credentials.
  - Ch·∫°y: `docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d`
- **Bi·∫øn m√¥i tr∆∞·ªùng:**
  - S·ª≠ d·ª•ng file `.env` cho c√°c gi√° tr·ªã m·∫∑c ƒë·ªãnh ho·∫∑c kh√¥ng nh·∫°y c·∫£m.
  - Tr√™n server production, c√°c bi·∫øn m√¥i tr∆∞·ªùng nh·∫°y c·∫£m n√™n ƒë∆∞·ª£c inject b·ªüi h·ªá th·ªëng CI/CD ho·∫∑c orchestration platform, kh√¥ng n√™n commit v√†o Git.

## 8. üèãÔ∏è B√†i T·∫≠p

**Y√™u c·∫ßu:** M·ªü r·ªông b√†i t·∫≠p c·ªßa ph·∫ßn Docker c∆° b·∫£n (·ª©ng d·ª•ng web tƒ©nh v·ªõi Nginx) b·∫±ng c√°ch th√™m m·ªôt service backend API ƒë∆°n gi·∫£n v√† qu·∫£n l√Ω to√†n b·ªô b·∫±ng Docker Compose. Frontend s·∫Ω g·ªçi API n√†y ƒë·ªÉ l·∫•y d·ªØ li·ªáu.

**M√¥ t·∫£ chi ti·∫øt:**

- **Service 1: `frontend`**
  - S·ª≠ d·ª•ng image `nginx:alpine` (ho·∫∑c `httpd:alpine`).
  - Ph·ª•c v·ª• m·ªôt file `index.html` v√† (t√πy ch·ªçn) `style.css`.
  - `index.html` s·∫Ω c√≥ m·ªôt n√∫t. Khi nh·∫•n n√∫t, JavaScript s·∫Ω g·ªçi ƒë·∫øn m·ªôt endpoint API c·ªßa service `backend` (v√≠ d·ª•: `/api/data`) v√† hi·ªÉn th·ªã k·∫øt qu·∫£ tr·∫£ v·ªÅ l√™n trang.
  - Nginx c·∫ßn ƒë∆∞·ª£c c·∫•u h√¨nh ƒë·ªÉ **proxy c√°c request c√≥ ti·ªÅn t·ªë `/api/`** t·ªõi service `backend`.
- **Service 2: `backend`** (Service m·ªõi)
  - T·∫°o m·ªôt ·ª©ng d·ª•ng API c·ª±c k·ª≥ ƒë∆°n gi·∫£n b·∫±ng **Node.js/Express** (ho·∫∑c Python/Flask, Go,... t√πy b·∫°n ch·ªçn, nh∆∞ng v√≠ d·ª• s·∫Ω ∆∞u ti√™n Node.js).
  - API n√†y c√≥ m·ªôt endpoint, v√≠ d·ª• `/data` (khi Nginx proxy, n√≥ s·∫Ω l√† `/api/data` t·ª´ ph√≠a client). Endpoint n√†y tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng JSON, v√≠ d·ª•:
    `{"message": "Hello from Backend API managed by Docker Compose!", "timestamp": "2023-10-27T10:30:00Z"}`.
  - Vi·∫øt `Dockerfile` cho service `backend` n√†y.

**Nhi·ªám v·ª•:**

1. **C·∫•u tr√∫c th∆∞ m·ª•c d·ª± ki·∫øn:**

    ```text
    my_fullstack_app/
    ‚îú‚îÄ‚îÄ docker-compose.yml
    ‚îú‚îÄ‚îÄ .env                   # (T√πy ch·ªçn) Cho port c·ªßa frontend
    ‚îú‚îÄ‚îÄ frontend/              # Service frontend
    ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile         # Dockerfile cho Nginx (ch·ªß y·∫øu l√† COPY file)
    ‚îÇ   ‚îú‚îÄ‚îÄ nginx.conf       # C·∫•u h√¨nh Nginx ƒë·ªÉ proxy_pass
    ‚îÇ   ‚îî‚îÄ‚îÄ public/            # Th∆∞ m·ª•c ch·ª©a static files
    ‚îÇ       ‚îú‚îÄ‚îÄ index.html
    ‚îÇ       ‚îî‚îÄ‚îÄ style.css (optional)
    ‚îî‚îÄ‚îÄ backend/               # Service backend
        ‚îú‚îÄ‚îÄ Dockerfile         # Dockerfile cho Node.js API
        ‚îú‚îÄ‚îÄ package.json
        ‚îú‚îÄ‚îÄ server.js          # Code API
        ‚îî‚îÄ‚îÄ ...
    ```

2. **T·∫°o service `backend` (Node.js/Express):**

    - `cd backend`
    - `npm init -y`
    - `npm install express`
    - `server.js`:

      ```javascript
      const express = require("express");
      const app = express();
      const PORT = process.env.BACKEND_PORT || 3001; // Port backend l·∫Øng nghe B√äN TRONG container

      app.get("/data", (req, res) => {
        console.log("Backend /data endpoint hit!");
        res.json({
          message: "Hello from Backend API managed by Docker Compose!",
          timestamp: new Date().toISOString(),
          servedByHost: req.hostname, // S·∫Ω l√† container ID ho·∫∑c t√™n n·∫øu kh√¥ng c√≥ alias
        });
      });

      app.listen(PORT, "0.0.0.0", () => {
        // L·∫Øng nghe tr√™n t·∫•t c·∫£ network interfaces trong container
        console.log(`Backend API listening on port ${PORT}`);
      });
      ```

    - `Dockerfile` (trong `backend/`):

      ```dockerfile
      FROM node:18-alpine
      WORKDIR /usr/src/app
      COPY package*.json ./
      RUN npm install --production # Ch·ªâ c√†i production dependencies
      COPY . .
      # Bi·∫øn m√¥i tr∆∞·ªùng BACKEND_PORT c√≥ th·ªÉ ƒë∆∞·ª£c set trong docker-compose.yml
      # EXPOSE 3001 # Port m√† backend l·∫Øng nghe (ƒë√£ ƒë∆∞·ª£c set trong server.js)
      CMD [ "node", "server.js" ]
      ```

3. **C·∫•u h√¨nh Nginx Proxy cho `frontend`:**

    - `frontend/public/index.html`:

      ```html
      <!DOCTYPE html>
      <html>
        <head>
          <title>Frontend App</title>
          <style>
            body {
              font-family: sans-serif;
            }
            button {
              padding: 10px;
            }
            #result {
              margin-top: 20px;
              padding: 10px;
              border: 1px solid #ccc;
              background-color: #f9f9f9;
            }
          </style>
        </head>
        <body>
          <h1>Welcome to the Frontend!</h1>
          <button id="fetchDataBtn">Fetch Data from Backend</button>
          <div id="result">Click the button to see data.</div>

          <script>
            document
              .getElementById("fetchDataBtn")
              .addEventListener("click", async () => {
                const resultDiv = document.getElementById("result");
                resultDiv.textContent = "Loading...";
                try {
                  // Nginx s·∫Ω proxy request /api/data n√†y ƒë·∫øn service backend
                  const response = await fetch("/api/data");
                  if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  const data = await response.json();
                  resultDiv.innerHTML = `
                          <p><strong>Message:</strong> ${data.message}</p>
                          <p><strong>Timestamp:</strong> ${data.timestamp}</p>
                          <p><strong>Served by:</strong> ${data.servedByHost}</p>
                      `;
                } catch (error) {
                  resultDiv.textContent =
                    "Error fetching data: " + error.message;
                  console.error("Error:", error);
                }
              });
          </script>
        </body>
      </html>
      ```

    - `frontend/nginx.conf`:

      ```nginx
      # frontend/nginx.conf
      server {
          listen 80; # Nginx l·∫Øng nghe tr√™n port 80 B√äN TRONG container frontend
          server_name localhost;

          # Ph·ª•c v·ª• static files t·ª´ /usr/share/nginx/html (n∆°i ta s·∫Ω COPY public/ v√†o)
          location / {
              root   /usr/share/nginx/html;
              index  index.html index.htm;
              try_files $uri $uri/ /index.html; # Quan tr·ªçng cho SPA n·∫øu c√≥
          }

          # Proxy c√°c request /api/ t·ªõi service backend
          location /api/ {
              # 'backend_service' ph·∫£i kh·ªõp v·ªõi t√™n service c·ªßa backend trong docker-compose.yml
              # '3001' l√† port m√† backend API l·∫Øng nghe B√äN TRONG container c·ªßa n√≥
              proxy_pass http://backend_service:3001/; # D·∫•u / cu·ªëi c√πng quan tr·ªçng

              # C√°c headers n√†y gi√∫p backend bi·∫øt th√¥ng tin g·ªëc c·ªßa request
              proxy_set_header Host $host; # Gi·ªØ nguy√™n Host header g·ªëc
              proxy_set_header X-Real-IP $remote_addr; # IP c·ªßa client
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Danh s√°ch IP n·∫øu qua nhi·ªÅu proxy
              proxy_set_header X-Forwarded-Proto $scheme; # http ho·∫∑c https

              # (T√πy ch·ªçn) C·∫•u h√¨nh timeout
              # proxy_connect_timeout       60s;
              # proxy_send_timeout          60s;
              # proxy_read_timeout          60s;
          }

          # (T√πy ch·ªçn) T·∫Øt access log ho·∫∑c error log cho ƒë·ª° nhi·ªÖu khi dev
          # access_log off;
          # error_log /dev/null;
      }
      ```

    - `frontend/Dockerfile`:

      ```dockerfile
      FROM nginx:1.25-alpine

      # X√≥a config Nginx m·∫∑c ƒë·ªãnh
      RUN rm /etc/nginx/conf.d/default.conf

      # Copy file nginx.conf t√πy ch·ªânh v√†o v·ªã tr√≠ config c·ªßa Nginx
      COPY nginx.conf /etc/nginx/conf.d/default.conf

      # Copy to√†n b·ªô n·ªôi dung th∆∞ m·ª•c public/ (ch·ª©a index.html, style.css)
      # v√†o th∆∞ m·ª•c ph·ª•c v·ª• web m·∫∑c ƒë·ªãnh c·ªßa Nginx
      COPY ./public/ /usr/share/nginx/html/

      # EXPOSE 80 # Image nginx ƒë√£ l√†m vi·ªác n√†y
      # CMD ["nginx", "-g", "daemon off;"] # Image nginx ƒë√£ l√†m vi·ªác n√†y
      ```

4. **Vi·∫øt `docker-compose.yml` (trong `my_fullstack_app/`):**

    ```yaml
    version: "3.8"

    services:
      frontend_service: # T√™n service cho frontend
        build: ./frontend # ƒê∆∞·ªùng d·∫´n ƒë·∫øn th∆∞ m·ª•c ch·ª©a Dockerfile c·ªßa frontend
        container_name: my_frontend_nginx
        ports:
          - "${FRONTEND_PORT:-8080}:80" # Map port t·ª´ .env (m·∫∑c ƒë·ªãnh 8080) ra port 80 c·ªßa container frontend
        volumes:
          # Mount th∆∞ m·ª•c public v√† nginx.conf ƒë·ªÉ live reload khi dev (t√πy ch·ªçn)
          - ./frontend/public:/usr/share/nginx/html:ro # :ro cho read-only an to√†n h∆°n
          - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
        depends_on:
          - backend_service # Frontend ph·ª• thu·ªôc v√†o backend
        restart: unless-stopped

      backend_service: # T√™n service cho backend (kh·ªõp v·ªõi proxy_pass trong nginx.conf)
        build: ./backend
        container_name: my_backend_api
        environment:
          # BACKEND_PORT: 3001 # Port n√†y ƒë√£ ƒë∆∞·ª£c set trong server.js, c√≥ th·ªÉ set ·ªü ƒë√¢y ƒë·ªÉ ghi ƒë√®
          NODE_ENV: development
        # ports: # Kh√¥ng c·∫ßn map port backend ra host n·∫øu ch·ªâ frontend g·ªçi n·ªôi b·ªô
        #   - "3001:3001"
        volumes:
          - ./backend:/usr/src/app # Mount source code backend cho live reload
          - /usr/src/app/node_modules # ƒê·ªÉ kh√¥ng b·ªã ghi ƒë√® node_modules t·ª´ host
        restart: unless-stopped
        # (T√πy ch·ªçn) Th√™m healthcheck cho backend
        # healthcheck:
        #   test: ["CMD", "curl", "-f", "http://localhost:3001/data"] # Ho·∫∑c m·ªôt endpoint /health ƒë∆°n gi·∫£n
        #   interval: 30s
        #   timeout: 10s
        #   retries: 3
    # (T√πy ch·ªçn) ƒê·ªãnh nghƒ©a network n·∫øu mu·ªën custom
    # networks:
    #   app_network:
    #     driver: bridge
    ```

    - T·∫°o file `.env` (trong `my_fullstack_app/`) (t√πy ch·ªçn):

      ```env
      FRONTEND_PORT=8080
      ```

5. **Ch·∫°y v√† Ki·ªÉm tra:**
    - T·ª´ th∆∞ m·ª•c `my_fullstack_app`, ch·∫°y `docker-compose up --build`.
    - M·ªü tr√¨nh duy·ªát, truy c·∫≠p `http://localhost:8080` (ho·∫∑c port b·∫°n set trong `.env`).
    - Nh·∫•n n√∫t "Fetch Data from Backend". D·ªØ li·ªáu t·ª´ backend API (qua Nginx proxy) s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã.
    - Ki·ªÉm tra logs c·ªßa c√°c service: `docker-compose logs frontend_service`, `docker-compose logs backend_service`.
    - Th·ª≠ thay ƒë·ªïi code trong `backend/server.js` ho·∫∑c `frontend/public/index.html`. N·∫øu b·∫°n ƒë√£ mount volumes v√† d√πng `nodemon` cho backend (ho·∫∑c tr√¨nh duy·ªát t·ª± refresh cho frontend), b·∫°n s·∫Ω th·∫•y thay ƒë·ªïi m√† kh√¥ng c·∫ßn build l·∫°i (c√≥ th·ªÉ c·∫ßn restart service backend n·∫øu kh√¥ng c√≥ nodemon).
6. **D·ªçn d·∫πp:** `docker-compose down`

Ch√∫c b·∫°n th√†nh c√¥ng v·ªõi b√†i t·∫≠p n√†y! N√≥ s·∫Ω gi√∫p b·∫°n hi·ªÉu r√µ h∆°n v·ªÅ c√°ch c√°c service t∆∞∆°ng t√°c v·ªõi nhau trong Docker Compose.

## 9. üìö T√†i Li·ªáu Tham Kh·∫£o & Next Steps

- **Docker Official Documentation:** [https://docs.docker.com/](https://docs.docker.com/) (Ngu·ªìn t√†i li·ªáu to√†n di·ªán nh·∫•t)
- **Docker Compose CLI Reference:** [https://docs.docker.com/compose/reference/](https://docs.docker.com/compose/reference/)
- **Compose File Reference:** [https://docs.docker.com/compose/compose-file/](https://docs.docker.com/compose/compose-file/compose-file-v3/)
- **Best practices for writing Dockerfiles:** [https://docs.docker.com/develop/develop-images/dockerfile_best-practices/](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)
- **Docker Samples (GitHub):** [https://github.com/dockersamples](https://github.com/dockersamples) (Nhi·ªÅu v√≠ d·ª• th·ª±c t·∫ø)
- **Awesome Docker (Curated list on GitHub):** [https://github.com/veggiemonk/awesome-docker](https://github.com/veggiemonk/awesome-docker)
- **Play with Docker (Online Docker playground):** [https://labs.play-with-docker.com/](https://labs.play-with-docker.com/) (Th·ª±c h√†nh Docker m√† kh√¥ng c·∫ßn c√†i ƒë·∫∑t)
- **Bret Fisher's Docker and Kubernetes Resources:** [https://www.bretfisher.com/](https://www.bretfisher.com/) (Nhi·ªÅu kh√≥a h·ªçc v√† tips hay)

**Next Steps (Sau khi n·∫Øm v·ªØng nh·ªØng ki·∫øn th·ª©c n√†y):**

- **Multi-stage builds trong Dockerfile:** T√¨m hi·ªÉu s√¢u h∆°n ƒë·ªÉ t·ªëi ∆∞u image cho production.
- **Qu·∫£n l√Ω secrets v√† configurations n√¢ng cao:** Nghi√™n c·ª©u Docker secrets, Docker configs, ho·∫∑c c√°c tool nh∆∞ HashiCorp Vault.
- **Docker Swarm:** T√¨m hi·ªÉu v·ªÅ c√¥ng c·ª• orchestration container t√≠ch h·ª£p s·∫µn c·ªßa Docker, ƒë∆°n gi·∫£n h∆°n Kubernetes cho c√°c ·ª©ng d·ª•ng v·ª´a v√† nh·ªè.
- **Kubernetes (K8s):** "√îng vua" c·ªßa orchestration container, m·∫°nh m·∫Ω nh∆∞ng ph·ª©c t·∫°p h∆°n. C·∫ßn thi·∫øt cho c√°c h·ªá th·ªëng l·ªõn, ƒë√≤i h·ªèi t√≠nh s·∫µn s√†ng cao v√† kh·∫£ nƒÉng scale m·∫°nh.
- **T√≠ch h·ª£p Docker v√†o CI/CD pipelines:** T·ª± ƒë·ªông h√≥a qu√° tr√¨nh build, test, v√† deploy ·ª©ng d·ª•ng Dockerized (VD: v·ªõi Jenkins, GitLab CI, GitHub Actions).
- **Kh√°m ph√° c√°c private registries chuy√™n s√¢u:** AWS ECR, Google Artifact Registry (GCR c≈©), Azure CR, Harbor (t·ª± host).
- **Docker Security:** T√¨m hi·ªÉu v·ªÅ c√°c best practice ƒë·ªÉ b·∫£o m·∫≠t Docker images v√† containers (qu√©t l·ªó h·ªïng, image signing, runtime security).
- **Service Mesh (Istio, Linkerd):** Cho c√°c ·ª©ng d·ª•ng microservices ph·ª©c t·∫°p, qu·∫£n l√Ω traffic, observability, security gi·ªØa c√°c services.
- **Infrastructure as Code (Terraform, Pulumi):** K·∫øt h·ª£p Docker v·ªõi c√°c c√¥ng c·ª• IaC ƒë·ªÉ qu·∫£n l√Ω to√†n b·ªô h·∫° t·∫ßng.

---

[‚¨ÖÔ∏è Tr·ªü l·∫°i: DEVOPS/Docker1.md](./Docker1.md) |
[üè† Home](../README.md) |
[‚û°Ô∏è Ti·∫øp theo: (B√†i h·ªçc ti·∫øp theo, v√≠ d·ª• v·ªÅ Kubernetes ho·∫∑c CI/CD)](../DEVOPS/Kubernetes1.md)
