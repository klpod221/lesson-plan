# üê≥ DOCKER: ORCHESTRATION & BEST PRACTICES

- [üê≥ DOCKER: ORCHESTRATION \& BEST PRACTICES](#-docker-orchestration--best-practices)
  - [üéØ M·ª•c Ti√™u](#-m·ª•c-ti√™u)
  - [1. ‚è™ √în L·∫°i ph·∫ßn tr∆∞·ªõc](#1--√¥n-l·∫°i-ph·∫ßn-tr∆∞·ªõc)
    - [Key Concepts: Image, Container, Dockerfile](#key-concepts-image-container-dockerfile)
    - [Basic Docker CLI](#basic-docker-cli)
  - [2. üöÄ Gi·ªõi Thi·ªáu Docker Compose](#2--gi·ªõi-thi·ªáu-docker-compose)
    - [T·∫°i sao c·∫ßn Docker Compose? V·∫•n ƒë·ªÅ v·ªõi nhi·ªÅu `docker run`](#t·∫°i-sao-c·∫ßn-docker-compose-v·∫•n-ƒë·ªÅ-v·ªõi-nhi·ªÅu-docker-run)
    - [Docker Compose l√† g√¨?](#docker-compose-l√†-g√¨)
  - [3. üéº C√∫ Ph√°p `docker-compose.yml`](#3--c√∫-ph√°p-docker-composeyml)
    - [`version`](#version)
    - [`services`](#services)
    - [`build` vs `image`](#build-vs-image)
    - [`ports`](#ports)
    - [`volumes`](#volumes)
    - [`environment`](#environment)
    - [`depends_on`](#depends_on)
    - [`networks`](#networks)
    - [V√≠ d·ª• `docker-compose.yml` ƒë∆°n gi·∫£n](#v√≠-d·ª•-docker-composeyml-ƒë∆°n-gi·∫£n)
  - [4. üîó Docker Networking (v·ªõi Compose)](#4--docker-networking-v·ªõi-compose)
    - [M·∫°ng m·∫∑c ƒë·ªãnh (Default Network)](#m·∫°ng-m·∫∑c-ƒë·ªãnh-default-network)
    - [K·∫øt n·ªëi gi·ªØa c√°c services](#k·∫øt-n·ªëi-gi·ªØa-c√°c-services)
  - [5. üíæ Docker Volumes (v·ªõi Compose)](#5--docker-volumes-v·ªõi-compose)
    - [T·∫°i sao c·∫ßn Volumes? (Data Persistence)](#t·∫°i-sao-c·∫ßn-volumes-data-persistence)
    - [Named Volumes vs. Bind Mounts](#named-volumes-vs-bind-mounts)
    - [Khai b√°o v√† s·ª≠ d·ª•ng Volumes trong Compose](#khai-b√°o-v√†-s·ª≠-d·ª•ng-volumes-trong-compose)
  - [6. üõ†Ô∏è Th·ª±c H√†nh: X√¢y D·ª±ng ·ª®ng D·ª•ng Web + Database v·ªõi Docker Compose](#6-Ô∏è-th·ª±c-h√†nh-x√¢y-d·ª±ng-·ª©ng-d·ª•ng-web--database-v·ªõi-docker-compose)
  - [7. ‚ú® Best Practices \& M·∫πo](#7--best-practices--m·∫πo)
    - [Dockerfile Best Practices](#dockerfile-best-practices)
    - [Docker Compose Best Practices](#docker-compose-best-practices)
    - [`.dockerignore`](#dockerignore)
  - [8. üèãÔ∏è B√†i T·∫≠p](#8-Ô∏è-b√†i-t·∫≠p)
  - [9. üìö T√†i Li·ªáu Tham Kh·∫£o \& Next Steps](#9--t√†i-li·ªáu-tham-kh·∫£o--next-steps)

---

## üéØ M·ª•c Ti√™u

- Hi·ªÉu vai tr√≤ v√† l·ª£i √≠ch c·ªßa **Docker Compose**.
- N·∫Øm v·ªØng c√∫ ph√°p c∆° b·∫£n c·ªßa file `docker-compose.yml`.
- Bi·∫øt c√°ch ƒë·ªãnh nghƒ©a v√† qu·∫£n l√Ω **services**, **networks**, v√† **volumes** v·ªõi Docker Compose.
- Th·ª±c h√†nh x√¢y d·ª±ng m·ªôt ·ª©ng d·ª•ng **multi-container** ƒë∆°n gi·∫£n.
- T√¨m hi·ªÉu m·ªôt s·ªë **best practices** khi l√†m vi·ªác v·ªõi Docker v√† Docker Compose.

---

## 1. ‚è™ √în L·∫°i ph·∫ßn tr∆∞·ªõc

### Key Concepts: Image, Container, Dockerfile

- **Image**: Template read-only, ch·ª©a m·ªçi th·ª© c·∫ßn ƒë·ªÉ ch·∫°y ·ª©ng d·ª•ng.
- **Container**: Instance ch·∫°y c·ªßa m·ªôt image, m√¥i tr∆∞·ªùng isolated.
- **Dockerfile**: File text ch·ª©a instructions ƒë·ªÉ build image.

### Basic Docker CLI

- `docker build ...`
- `docker run ...`
- `docker ps`
- `docker images`
- `docker stop/rm ...`
- `docker logs ...`
- `docker exec ...`

## 2. üöÄ Gi·ªõi Thi·ªáu Docker Compose

### T·∫°i sao c·∫ßn Docker Compose? V·∫•n ƒë·ªÅ v·ªõi nhi·ªÅu `docker run`

H√£y t∆∞·ªüng t∆∞·ª£ng m·ªôt ·ª©ng d·ª•ng web ƒëi·ªÉn h√¨nh:

- M·ªôt `web server` (Nginx, Apache)
- M·ªôt `application server` (Node.js, Python/Flask, Java/Spring)
- M·ªôt `database` (PostgreSQL, MySQL, MongoDB)
- (C√≥ th·ªÉ) M·ªôt `caching service` (Redis)

N·∫øu d√πng `docker run` cho t·ª´ng service:

```bash
# Ch·∫°y database
docker run -d --name my_db -e POSTGRES_PASSWORD=secret postgres:13

# Ch·∫°y backend app, link t·ªõi DB, expose port
# C·∫ßn ƒë·ª£i DB s·∫µn s√†ng, l·∫•y IP c·ªßa DB (ho·∫∑c d√πng Docker network)
docker run -d --name my_app --link my_db:db -p 3000:3000 my_backend_image

# Ch·∫°y frontend, link t·ªõi backend
docker run -d --name my_frontend -p 80:80 --link my_app:api my_frontend_image
```

- **R·∫•t nhi·ªÅu l·ªánh** c·∫ßn nh·ªõ v√† g√µ.
- **Kh√≥ qu·∫£n l√Ω** dependencies (service A c·∫ßn service B ch·∫°y tr∆∞·ªõc).
- **Kh√≥ scale** (tƒÉng s·ªë l∆∞·ª£ng instance c·ªßa m·ªôt service).
- **Kh√≥ chia s·∫ª** c·∫•u h√¨nh v·ªõi team.

### Docker Compose l√† g√¨?

- L√† m·ªôt c√¥ng c·ª• ƒë·ªÉ **ƒë·ªãnh nghƒ©a (define)** v√† **ch·∫°y (run)** c√°c ·ª©ng d·ª•ng Docker **ƒëa-container (multi-container)**.
- S·ª≠ d·ª•ng m·ªôt file YAML (th∆∞·ªùng l√† `docker-compose.yml`) ƒë·ªÉ c·∫•u h√¨nh t·∫•t c·∫£ c√°c `services`, `networks`, v√† `volumes` c·ªßa ·ª©ng d·ª•ng.
- V·ªõi m·ªôt l·ªánh duy nh·∫•t (`docker-compose up`), b·∫°n c√≥ th·ªÉ kh·ªüi t·∫°o v√† ch·∫°y to√†n b·ªô ·ª©ng d·ª•ng.

**L·ª£i √≠ch:**

- **ƒê∆°n gi·∫£n h√≥a** vi·ªác qu·∫£n l√Ω ·ª©ng d·ª•ng multi-container.
- **D·ªÖ d√†ng t√°i t·∫°o** m√¥i tr∆∞·ªùng ph√°t tri·ªÉn, testing, staging.
- **T√≠ch h·ª£p t·ªët** v·ªõi Docker Engine.
- **Qu·∫£n l√Ω t·∫≠p trung** c·∫•u h√¨nh ·ª©ng d·ª•ng.

[H√¨nh ·∫£nh: S∆° ƒë·ªì m·ªôt ·ª©ng d·ª•ng web (frontend, backend, db) ƒë∆∞·ª£c qu·∫£n l√Ω b·ªüi Docker Compose]

## 3. üéº C√∫ Ph√°p `docker-compose.yml`

File `docker-compose.yml` l√† tr√°i tim c·ªßa Docker Compose.

### `version`

Ch·ªâ ƒë·ªãnh phi√™n b·∫£n c·ªßa c√∫ ph√°p file Compose. N√™n d√πng phi√™n b·∫£n m·ªõi nh·∫•t ƒë∆∞·ª£c h·ªó tr·ª£.

```yaml
version: "3.8" # Ho·∫∑c "3.9", "3.x"
```

### `services`

N∆°i ƒë·ªãnh nghƒ©a c√°c container (services) c·ªßa ·ª©ng d·ª•ng. M·ªói key d∆∞·ªõi `services` l√† t√™n c·ªßa m·ªôt service.

```yaml
services:
  web:
    # C·∫•u h√¨nh cho service 'web'
  api:
    # C·∫•u h√¨nh cho service 'api'
  db:
    # C·∫•u h√¨nh cho service 'db'
```

### `build` vs `image`

- `image: <image_name>:<tag>`: Ch·ªâ ƒë·ªãnh image c√≥ s·∫µn t·ª´ Docker Hub ho·∫∑c private registry.

  ```yaml
  services:
    database:
      image: postgres:14-alpine
  ```

- `build: <path_to_dockerfile_directory>`: Ch·ªâ ƒë·ªãnh Docker Compose build image t·ª´ Dockerfile.

  - C√≥ th·ªÉ l√† m·ªôt string (ƒë∆∞·ªùng d·∫´n): `build: ./backend`
  - Ho·∫∑c m·ªôt object ƒë·ªÉ cung c·∫•p th√™m chi ti·∫øt:

  ```yaml
  services:
    backend:
      build:
        context: ./app_folder # Th∆∞ m·ª•c ch·ª©a Dockerfile
        dockerfile: Dockerfile.dev # T√™n Dockerfile (n·∫øu kh√°c Dockerfile)
        args: # Bi·∫øn truy·ªÅn v√†o l√∫c build
          NODE_VERSION: 18
  ```

  B·∫°n c√≥ th·ªÉ d√πng c·∫£ hai: `build` image n·∫øu kh√¥ng t√¨m th·∫•y `image` ƒë√£ c√≥ t√™n ƒë√≥.

### `ports`

Map ports gi·ªØa host v√† container. `HOST:CONTAINER`

```yaml
services:
  frontend:
    image: nginx:latest
    ports:
      - "8080:80" # Map port 8080 c·ªßa host t·ªõi port 80 c·ªßa container frontend
```

### `volumes`

Mount th∆∞ m·ª•c t·ª´ host v√†o container (bind mount) ho·∫∑c qu·∫£n l√Ω data volumes (named volumes).

```yaml
services:
  backend:
    image: myapp-backend
    volumes:
      - ./src:/app/src # Bind mount: thay ƒë·ªïi code ·ªü host -> thay ƒë·ªïi trong container (dev)
      - logs_data:/app/logs # Named volume: l∆∞u tr·ªØ logs b·ªÅn b·ªâ
  database:
    image: postgres:14
    volumes:
      - db_data:/var/lib/postgresql/data # Named volume: l∆∞u tr·ªØ data c·ªßa DB

volumes: # Khai b√°o top-level named volumes
  db_data:
  logs_data:
```

S·∫Ω n√≥i chi ti·∫øt h∆°n ·ªü ph·∫ßn Docker Volumes.

### `environment`

Thi·∫øt l·∫≠p bi·∫øn m√¥i tr∆∞·ªùng cho container.

- D·∫°ng list:

  ```yaml
  services:
    api:
      image: my-api
      environment:
        - NODE_ENV=development
        - DATABASE_URL=postgresql://user:pass@db:5432/mydb
  ```

- D·∫°ng map:

  ```yaml
  services:
    api:
      image: my-api
      environment:
        NODE_ENV: development
        DATABASE_URL: postgresql://user:pass@db:5432/mydb
  ```

- T·ª´ file `.env` (file `.env` n·∫±m c√πng c·∫•p v·ªõi `docker-compose.yml`):

  ```yaml
  # .env file
  POSTGRES_USER=myuser
  POSTGRES_PASSWORD=mypassword
  ```

  ```yaml
  # docker-compose.yml
  services:
    db:
      image: postgres
      environment:
        POSTGRES_USER: ${POSTGRES_USER} # Tham chi·∫øu t·ª´ .env
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  ```

  Ho·∫∑c d√πng `env_file`:

  ```yaml
  services:
    api:
      image: my-api
      env_file:
        - ./api.env # ƒê∆∞·ªùng d·∫´n t·ªõi file env c·ª• th·ªÉ
  ```

### `depends_on`

Ch·ªâ ƒë·ªãnh th·ª© t·ª± kh·ªüi ƒë·ªông gi·ªØa c√°c services. Service A `depends_on` Service B nghƒ©a l√† Service B s·∫Ω ƒë∆∞·ª£c kh·ªüi ƒë·ªông _tr∆∞·ªõc_ Service A.
**L∆∞u √Ω:** `depends_on` ch·ªâ ƒë·∫£m b·∫£o container c·ªßa service ph·ª• thu·ªôc ƒë√£ _kh·ªüi ƒë·ªông_, kh√¥ng ƒë·∫£m b·∫£o ·ª©ng d·ª•ng b√™n trong container ƒë√≥ ƒë√£ _s·∫µn s√†ng_ (v√≠ d·ª•: database c·∫ßn th·ªùi gian ƒë·ªÉ initialize).

```yaml
services:
  api:
    image: my-api
    depends_on:
      - db # api s·∫Ω kh·ªüi ƒë·ªông sau khi db kh·ªüi ƒë·ªông
  db:
    image: postgres
```

### `networks`

Cho ph√©p services k·∫øt n·ªëi v·ªõi nhau. Docker Compose t·ª± ƒë·ªông t·∫°o m·ªôt default network cho t·∫•t c·∫£ services trong file.

```yaml
services:
  frontend:
    image: nginx
    networks:
      - front-tier
  api:
    image: my-api
    networks:
      - front-tier
      - back-tier
  db:
    image: postgres
    networks:
      - back-tier

networks: # Khai b√°o top-level networks
  front-tier:
  back-tier:
```

S·∫Ω n√≥i chi ti·∫øt h∆°n ·ªü ph·∫ßn Docker Networking.

### V√≠ d·ª• `docker-compose.yml` ƒë∆°n gi·∫£n

```yaml
version: "3.8"

services:
  # Service web server (v√≠ d·ª•: Node.js app)
  web:
    build: ./app # Th∆∞ m·ª•c ch·ª©a Dockerfile c·ªßa app
    ports:
      - "3000:3000" # Map port 3000 c·ªßa host t·ªõi port 3000 c·ªßa container
    volumes:
      - ./app:/usr/src/app # Mount source code v√†o container ƒë·ªÉ live reload
      - /usr/src/app/node_modules # NgƒÉn node_modules c·ªßa host ghi ƒë√® node_modules trong image
    environment:
      - NODE_ENV=development
    depends_on:
      - redis # Web app ph·ª• thu·ªôc v√†o Redis

  # Service Redis (caching)
  redis:
    image: "redis:alpine"
    ports: # Kh√¥ng nh·∫•t thi·∫øt ph·∫£i expose port Redis ra host n·∫øu ch·ªâ app n·ªôi b·ªô d√πng
      - "6379:6379" # V√≠ d·ª• n·∫øu mu·ªën k·∫øt n·ªëi t·ª´ host v√†o Redis n√†y
```

**C·∫•u tr√∫c th∆∞ m·ª•c v√≠ d·ª•:**

```text
my_project/
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ .env (t√πy ch·ªçn)
‚îî‚îÄ‚îÄ app/
    ‚îú‚îÄ‚îÄ Dockerfile
    ‚îú‚îÄ‚îÄ package.json
    ‚îî‚îÄ‚îÄ server.js
    ‚îî‚îÄ‚îÄ ... (c√°c file kh√°c c·ªßa app)
```

**C√°c l·ªánh Docker Compose c∆° b·∫£n:**

- `docker-compose up`: Build (n·∫øu c·∫ßn), t·∫°o v√† kh·ªüi ƒë·ªông c√°c services.
  - `docker-compose up -d`: Ch·∫°y ·ªü background (detached mode).
  - `docker-compose up --build`: Lu√¥n build l·∫°i images tr∆∞·ªõc khi kh·ªüi ƒë·ªông.
- `docker-compose down`: D·ª´ng v√† x√≥a containers, networks.
  - `docker-compose down -v`: X√≥a c·∫£ named volumes.
- `docker-compose ps`: Li·ªát k√™ c√°c containers do Compose qu·∫£n l√Ω.
- `docker-compose logs <service_name>`: Xem logs c·ªßa m·ªôt service.
  - `docker-compose logs -f <service_name>`: Theo d√µi logs.
- `docker-compose exec <service_name> <command>`: Ch·∫°y l·ªánh trong m·ªôt service ƒëang ch·∫°y.
  - `docker-compose exec web bash`
- `docker-compose build <service_name>`: Build (ho·∫∑c rebuild) image cho service.
- `docker-compose pull <service_name>`: Pull image cho service (n·∫øu d√πng `image:`).
- `docker-compose start/stop/restart <service_name>`: Qu·∫£n l√Ω lifecycle c·ªßa service.

## 4. üîó Docker Networking (v·ªõi Compose)

### M·∫°ng m·∫∑c ƒë·ªãnh (Default Network)

- Khi b·∫°n ch·∫°y `docker-compose up`, Compose s·∫Ω t·ª± ƒë·ªông t·∫°o m·ªôt **user-defined bridge network** m·∫∑c ƒë·ªãnh cho ·ª©ng d·ª•ng c·ªßa b·∫°n.
- T√™n network th∆∞·ªùng l√† `<project_name>_default` (project_name l√† t√™n th∆∞ m·ª•c ch·ª©a `docker-compose.yml`).
- T·∫•t c·∫£ c√°c `services` trong file `docker-compose.yml` s·∫Ω ƒë∆∞·ª£c k·∫øt n·ªëi v√†o network n√†y.

### K·∫øt n·ªëi gi·ªØa c√°c services

- B√™n trong network n√†y, c√°c containers c√≥ th·ªÉ **tham chi·∫øu (resolve) l·∫´n nhau b·∫±ng t√™n service** ƒë√£ ƒë·ªãnh nghƒ©a trong `docker-compose.yml`.
- V√≠ d·ª•, service `web` c√≥ th·ªÉ k·∫øt n·ªëi t·ªõi service `db` qua hostname `db` (v√≠ d·ª•: `postgres://user:pass@db:5432/mydb`). Docker s·∫Ω t·ª± ƒë·ªông resolve `db` th√†nh IP n·ªôi b·ªô c·ªßa container `db`.
- B·∫°n kh√¥ng c·∫ßn d√πng `links` (ƒë√£ c≈©) hay expose port c·ªßa DB ra host n·∫øu ch·ªâ c√≥ c√°c service kh√°c trong c√πng Compose network c·∫ßn truy c·∫≠p.

**S∆° ƒë·ªì:**

```text
  Host Machine
  -------------------------------------------------
  |                                               |
  |   Docker Network: myproject_default           |
  |   -----------------------------------------   |
  |   | Service: web (IP: 172.x.x.2)          |   |  <-- c√≥ th·ªÉ k·∫øt n·ªëi t·ªõi 'db:5432'
  |   |  - Nginx/Node.js                      |   |
  |   -----------------------------------------   |
  |   | Service: api (IP: 172.x.x.3)          |   |  <-- c√≥ th·ªÉ k·∫øt n·ªëi t·ªõi 'db:5432'
  |   |  - Python/Java                        |   |
  |   -----------------------------------------   |
  |   | Service: db (IP: 172.x.x.4)           |   |  <-- L·∫Øng nghe tr√™n port 5432 n·ªôi b·ªô
  |   |  - PostgreSQL/MySQL                   |   |
  |   -----------------------------------------   |
  |                                               |
  -------------------------------------------------
```

- Service `web` c√≥ th·ªÉ truy c·∫≠p service `db` t·∫°i ƒë·ªãa ch·ªâ `db:5432` (n·∫øu `db` l√† PostgreSQL).
- Kh√¥ng c·∫ßn `EXPOSE` port c·ªßa `db` ra ngo√†i host machine n·∫øu ch·ªâ c√°c services kh√°c trong c√πng network n√†y c·∫ßn truy c·∫≠p.

## 5. üíæ Docker Volumes (v·ªõi Compose)

### T·∫°i sao c·∫ßn Volumes? (Data Persistence)

- Containers l√† **ephemeral** (t·∫°m th·ªùi). Khi container b·ªã x√≥a, m·ªçi d·ªØ li·ªáu ƒë∆∞·ª£c ghi v√†o filesystem c·ªßa n√≥ (tr·ª´ khi d√πng volume) s·∫Ω b·ªã **m·∫•t**.
- ƒê·ªëi v·ªõi database, user uploads, logs quan tr·ªçng, ch√∫ng ta c·∫ßn **l∆∞u tr·ªØ d·ªØ li·ªáu b·ªÅn b·ªâ (persistently)**.

### Named Volumes vs. Bind Mounts

1. **Named Volumes:**

   - ƒê∆∞·ª£c Docker qu·∫£n l√Ω ho√†n to√†n. D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr·ªØ trong m·ªôt ph·∫ßn ƒë·∫∑c bi·ªát c·ªßa host filesystem do Docker qu·∫£n l√Ω (`/var/lib/docker/volumes/` tr√™n Linux).
   - **∆Øu ƒëi·ªÉm:** ƒê·ªôc l·∫≠p v·ªõi c·∫•u tr√∫c th∆∞ m·ª•c c·ªßa host, d·ªÖ d√†ng backup/migrate, performance t·ªët h∆°n tr√™n m·ªôt s·ªë OS (macOS, Windows).
   - Khai b√°o ·ªü top-level `volumes:` v√† tham chi·∫øu trong service.

   ```yaml
   services:
     database:
       image: postgres
       volumes:
         - db_data:/var/lib/postgresql/data
   volumes:
     db_data: # Docker s·∫Ω t·∫°o v√† qu·∫£n l√Ω volume t√™n l√† 'myproject_db_data'
   ```

2. **Bind Mounts:**

   - Mount m·ªôt file ho·∫∑c th∆∞ m·ª•c t·ª´ **host machine** v√†o container.
   - **∆Øu ƒëi·ªÉm:** R·∫•t ti·ªán cho development, khi b·∫°n thay ƒë·ªïi code tr√™n host, thay ƒë·ªïi ƒë√≥ ƒë∆∞·ª£c ph·∫£n √°nh ngay l·∫≠p t·ª©c v√†o container.
   - **Nh∆∞·ª£c ƒëi·ªÉm:** Ph·ª• thu·ªôc v√†o c·∫•u tr√∫c th∆∞ m·ª•c c·ªßa host. C√≥ th·ªÉ g√¢y v·∫•n ƒë·ªÅ v·ªÅ performance ho·∫∑c permission tr√™n m·ªôt s·ªë OS.

   ```yaml
   services:
     web:
       build: ./app
       volumes:
         - ./app/src:/usr/src/app/src # Mount code t·ª´ host v√†o container
   ```

**Khi n√†o d√πng c√°i n√†o?**

- **Named Volumes:** Cho d·ªØ li·ªáu ·ª©ng d·ª•ng c·∫ßn t√≠nh b·ªÅn b·ªâ (database data, user uploads).
- **Bind Mounts:** Cho source code trong m√¥i tr∆∞·ªùng development (ƒë·ªÉ live-reloading), ho·∫∑c cho file c·∫•u h√¨nh.

### Khai b√°o v√† s·ª≠ d·ª•ng Volumes trong Compose

ƒê√£ ƒë∆∞·ª£c minh h·ªça ·ªü tr√™n.

- Khai b√°o ·ªü `volumes:` top-level cho named volumes.
- S·ª≠ d·ª•ng trong `services.<service_name>.volumes`.

## 6. üõ†Ô∏è Th·ª±c H√†nh: X√¢y D·ª±ng ·ª®ng D·ª•ng Web + Database v·ªõi Docker Compose

**M·ª•c ti√™u:** T·∫°o m·ªôt ·ª©ng d·ª•ng ƒë∆°n gi·∫£n g·ªìm 2 services:

1. `web`: M·ªôt ·ª©ng d·ª•ng Node.js/Express ƒë∆°n gi·∫£n c√≥ th·ªÉ ghi v√† ƒë·ªçc m·ªôt message t·ª´ Redis.
2. `redis`: M·ªôt Redis instance.

**C·∫•u tr√∫c th∆∞ m·ª•c:**

```text
compose_practice/
‚îú‚îÄ‚îÄ docker-compose.yml
‚îî‚îÄ‚îÄ web_app/
    ‚îú‚îÄ‚îÄ Dockerfile
    ‚îú‚îÄ‚îÄ package.json
    ‚îî‚îÄ‚îÄ server.js
```

**1. `web_app/package.json`:**

```json
{
  "name": "web-app-redis",
  "version": "1.0.0",
  "description": "Simple Node.js app with Redis",
  "main": "server.js",
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "express": "^4.17.1",
    "redis": "^3.1.2" // L∆∞u √Ω: version 3.x.x c·ªßa redis client
  }
}
```

_(L∆∞u √Ω: `redis` v4+ d√πng Promises, v3 d√πng callbacks. V√≠ d·ª• n√†y d√πng v3 cho ƒë∆°n gi·∫£n.)_

**2. `web_app/server.js`:**

```javascript
// web_app/server.js
const express = require("express");
const redis = require("redis");
const app = express();
const port = 3000;

// K·∫øt n·ªëi t·ªõi Redis - 'redis-server' l√† t√™n service trong docker-compose.yml
const redisClient = redis.createClient({ host: "redis-server", port: 6379 });

redisClient.on("connect", () => {
  console.log("Connected to Redis!");
});
redisClient.on("error", (err) => {
  console.error("Redis error: ", err);
});

app.use(express.json()); // Middleware ƒë·ªÉ parse JSON body

app.get("/", (req, res) => {
  redisClient.get("message", (err, message) => {
    if (err) return res.status(500).send(err.toString());
    res.send(`Current message: ${message || "No message set yet!"}`);
  });
});

app.post("/message", (req, res) => {
  const { message } = req.body;
  if (!message) {
    return res.status(400).send("Message is required");
  }
  redisClient.set("message", message, (err, reply) => {
    if (err) return res.status(500).send(err.toString());
    res.send(`Message set to: ${message}`);
  });
});

app.listen(port, () => {
  console.log(`Web app listening at http://localhost:${port}`);
});
```

**3. `web_app/Dockerfile`:**

```dockerfile
FROM node:16-alpine

WORKDIR /usr/src/app

COPY package*.json ./
RUN npm install

COPY . .

EXPOSE 3000
CMD [ "npm", "start" ]
```

**4. `docker-compose.yml` (trong th∆∞ m·ª•c `compose_practice`):**

```yaml
version: "3.8"

services:
  webapp:
    build: ./web_app # ƒê∆∞·ªùng d·∫´n t·ªõi th∆∞ m·ª•c ch·ª©a Dockerfile c·ªßa web_app
    ports:
      - "3000:3000"
    volumes:
      - ./web_app:/usr/src/app # Mount source code ƒë·ªÉ live reload
      - /usr/src/app/node_modules # Quan tr·ªçng: ƒë·ªÉ kh√¥ng b·ªã ghi ƒë√® b·ªüi node_modules c·ªßa host (n·∫øu c√≥)
    environment:
      - NODE_ENV=development
    depends_on:
      - redis-server # ƒê·∫£m b·∫£o redis-server kh·ªüi ƒë·ªông tr∆∞·ªõc webapp

  redis-server:
    image: "redis:alpine"
    # Kh√¥ng c·∫ßn expose port 6379 ra host n·∫øu ch·ªâ webapp d√πng
    # ports:
    #   - "6379:6379"
    volumes:
      - redis_data:/data # Named volume ƒë·ªÉ l∆∞u d·ªØ li·ªáu Redis

volumes:
  redis_data: # Khai b√°o named volume
```

**Ch·∫°y ·ª©ng d·ª•ng:**

1. M·ªü terminal trong th∆∞ m·ª•c `compose_practice`.
2. Ch·∫°y `npm install` b√™n trong `web_app` ƒë·ªÉ t·∫°o `package-lock.json` (n·∫øu b·∫°n mu·ªën c√≥ file n√†y ƒë∆∞·ª£c copy v√†o image, ho·∫∑c b·ªè qua b∆∞·ªõc n√†y v√† ƒë·ªÉ `RUN npm install` trong Dockerfile t·ª± x·ª≠ l√Ω).
3. Ch·∫°y: `docker-compose up --build` (ho·∫∑c `docker-compose up -d --build` ƒë·ªÉ ch·∫°y background).
4. Ki·ªÉm tra:

   - M·ªü tr√¨nh duy·ªát: `http://localhost:3000` -> S·∫Ω th·∫•y "Current message: No message set yet!"
   - D√πng Postman ho·∫∑c `curl` ƒë·ªÉ POST message:

     ```bash
     curl -X POST -H "Content-Type: application/json" -d '{"message":"Hello Docker Compose!"}' http://localhost:3000/message
     ```

   - Refresh tr√¨nh duy·ªát: `http://localhost:3000` -> S·∫Ω th·∫•y "Current message: Hello Docker Compose!"

5. D·ªçn d·∫πp: `docker-compose down -v` (ƒë·ªÉ x√≥a c·∫£ volume `redis_data`).

## 7. ‚ú® Best Practices & M·∫πo

### Dockerfile Best Practices

- **Use official images** l√†m base image n·∫øu c√≥ th·ªÉ (an to√†n, ƒë∆∞·ª£c maintain).
- **Use specific tags** (VD: `node:18-alpine` thay v√¨ `node:latest`).
- **Minimize layers**: K·∫øt h·ª£p c√°c l·ªánh `RUN` n·∫øu c√≥ th·ªÉ (VD: `RUN apt-get update && apt-get install -y ... && rm -rf /var/lib/apt/lists/*`). M·ªói `RUN` t·∫°o m·ªôt layer.
- **Order matters for caching**: ƒê·∫∑t c√°c instruction √≠t thay ƒë·ªïi l√™n tr√™n (VD: `COPY package.json` v√† `RUN npm install` tr∆∞·ªõc `COPY . .`).
- **Use `.dockerignore`**: Lo·∫°i b·ªè c√°c file/folder kh√¥ng c·∫ßn thi·∫øt (VD: `.git`, `node_modules` c·ªßa host, logs) kh·ªèi build context ƒë·ªÉ build nhanh h∆°n v√† image nh·ªè h∆°n.
- **Run as non-root user**: TƒÉng c∆∞·ªùng b·∫£o m·∫≠t (`USER` instruction).
- **Use multi-stage builds**: ƒê·ªÉ t·∫°o image production nh·ªè g·ªçn, ch·ªâ ch·ª©a runtime, kh√¥ng ch·ª©a build tools.
- **`COPY` thay v√¨ `ADD`** cho file/folder c·ª•c b·ªô (√≠t "magic" h∆°n `ADD`). `ADD` c√≥ th·ªÉ gi·∫£i n√©n tarball ho·∫∑c fetch URL.

### Docker Compose Best Practices

- **S·ª≠ d·ª•ng `version: "3.x"`** (phi√™n b·∫£n m·ªõi nh·∫•t b·∫°n c·∫ßn).
- **ƒê·∫∑t t√™n services r√µ r√†ng**.
- **S·ª≠ d·ª•ng bi·∫øn m√¥i tr∆∞·ªùng (`.env` file)** cho c√°c c·∫•u h√¨nh nh·∫°y c·∫£m ho·∫∑c thay ƒë·ªïi gi·ªØa c√°c m√¥i tr∆∞·ªùng. Kh√¥ng hardcode credentials.
- **S·ª≠ d·ª•ng `depends_on`** m·ªôt c√°ch h·ª£p l√Ω, nh∆∞ng hi·ªÉu r·∫±ng n√≥ ch·ªâ ƒë·∫£m b·∫£o container kh·ªüi ƒë·ªông, kh√¥ng ph·∫£i ·ª©ng d·ª•ng s·∫µn s√†ng. C√¢n nh·∫Øc d√πng `healthcheck` ho·∫∑c c√°c script `wait-for-it.sh`.
- **Ch·ªâ `expose` ports ra host khi th·ª±c s·ª± c·∫ßn**. C√°c service giao ti·∫øp n·ªôi b·ªô qua network c·ªßa Compose.
- **S·ª≠ d·ª•ng `volumes`** cho persistent data v√† source code khi dev.
- **T√°ch bi·ªát config cho dev, staging, prod** b·∫±ng c√°ch s·ª≠ d·ª•ng nhi·ªÅu file compose (VD: `docker-compose.yml`, `docker-compose.override.yml`, `docker-compose.prod.yml`) v√† `-f` option.
  - `docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d`

### `.dockerignore`

T∆∞∆°ng t·ª± `.gitignore`, file `.dockerignore` (ƒë·∫∑t c√πng c·∫•p v·ªõi `Dockerfile`) ch·ªâ ƒë·ªãnh c√°c file/folder s·∫Ω **KH√îNG** ƒë∆∞·ª£c g·ª≠i t·ªõi Docker daemon khi build image.
V√≠ d·ª• `.dockerignore`:

```text
.git
.vscode
node_modules
npm-debug.log
Dockerfile
.dockerignore
README.md
*.env
```

ƒêi·ªÅu n√†y gi√∫p:

- **Gi·∫£m k√≠ch th∆∞·ªõc build context** -> build nhanh h∆°n.
- **Tr√°nh v√¥ t√¨nh copy file nh·∫°y c·∫£m** v√†o image.
- **Tr√°nh ghi ƒë√® file/folder** ƒë√£ ƒë∆∞·ª£c t·∫°o b·ªüi c√°c `RUN` command (VD: `node_modules` trong image).

## 8. üèãÔ∏è B√†i T·∫≠p

**Y√™u c·∫ßu:** M·ªü r·ªông b√†i t·∫≠p c·ªßa ph·∫ßn tr∆∞·ªõc b·∫±ng c√°ch th√™m m·ªôt service backend ƒë∆°n gi·∫£n v√† qu·∫£n l√Ω to√†n b·ªô b·∫±ng Docker Compose.

**M√¥ t·∫£:**

- **Service 1: `frontend`** (T·ª´ b√†i t·∫≠p 1)
  - S·ª≠ d·ª•ng image `nginx:alpine` (ho·∫∑c `httpd:alpine`) ƒë·ªÉ ph·ª•c v·ª• c√°c file HTML tƒ©nh c·ªßa b·∫°n.
  - Nginx c·∫ßn ƒë∆∞·ª£c c·∫•u h√¨nh ƒë·ªÉ **proxy c√°c request API** (v√≠ d·ª•: `/api/*`) t·ªõi service `backend`.
- **Service 2: `backend`** (Service m·ªõi)
  - T·∫°o m·ªôt ·ª©ng d·ª•ng API r·∫•t ƒë∆°n gi·∫£n b·∫±ng Node.js/Express (ho·∫∑c Python/Flask, Go,... t√πy b·∫°n ch·ªçn).
  - API n√†y c√≥ m·ªôt endpoint, v√≠ d·ª• `/api/message`, tr·∫£ v·ªÅ m·ªôt chu·ªói JSON nh∆∞ `{"text": "Hello from Backend API via Compose!"}`.
  - Vi·∫øt `Dockerfile` cho service `backend` n√†y.

**Nhi·ªám v·ª•:**

1. **C·∫•u tr√∫c th∆∞ m·ª•c d·ª± ki·∫øn:**

   ```text
   my_compose_app/
   ‚îú‚îÄ‚îÄ docker-compose.yml
   ‚îú‚îÄ‚îÄ frontend/
   ‚îÇ   ‚îú‚îÄ‚îÄ index.html
   ‚îÇ   ‚îú‚îÄ‚îÄ style.css (optional)
   ‚îÇ   ‚îî‚îÄ‚îÄ nginx.conf (C·∫•u h√¨nh Nginx ƒë·ªÉ proxy)
   ‚îî‚îÄ‚îÄ backend/
       ‚îú‚îÄ‚îÄ Dockerfile
       ‚îú‚îÄ‚îÄ package.json (n·∫øu l√† Node.js)
       ‚îú‚îÄ‚îÄ server.js (ho·∫∑c app.py, main.go,...)
       ‚îî‚îÄ‚îÄ ...
   ```

2. **T·∫°o service `backend`:**

   - Vi·∫øt code cho API ƒë∆°n gi·∫£n (v√≠ d·ª•: `server.js` cho Node).
   - Vi·∫øt `Dockerfile` cho service `backend`.

3. **C·∫•u h√¨nh Nginx Proxy cho `frontend`:**

   - T·∫°o file `nginx.conf` (ho·∫∑c file config t∆∞∆°ng ·ª©ng cho web server b·∫°n ch·ªçn).
   - Trong `nginx.conf`, c·∫•u h√¨nh ƒë·ªÉ c√°c request ƒë·∫øn `/api` ƒë∆∞·ª£c chuy·ªÉn ti·∫øp (proxy_pass) ƒë·∫øn service `backend` (v√≠ d·ª•: `http://backend_service_name:port_backend_chay_tren_do/`).

     ```nginx
     // V√≠ d·ª• nginx.conf (ƒë∆°n gi·∫£n)
     server {
         listen 80;
         server_name localhost;

         location / {
             root   /usr/share/nginx/html;
             index  index.html index.htm;
             try_files $uri $uri/ /index.html; # Quan tr·ªçng cho SPA n·∫øu c√≥
         }

         location /api/ {
             # T√™n 'backend' ph·∫£i kh·ªõp v·ªõi t√™n service trong docker-compose.yml
             # Port 3000 l√† port backend API l·∫Øng nghe B√äN TRONG container c·ªßa n√≥
             proxy_pass http://backend:3000/;
             proxy_set_header Host $host;
             proxy_set_header X-Real-IP $remote_addr;
             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
             proxy_set_header X-Forwarded-Proto $scheme;
         }
     }
     ```

   - `Dockerfile` c·ªßa `frontend` s·∫Ω c·∫ßn `COPY` file `index.html` (v√† c√°c assets kh√°c) v√†o `/usr/share/nginx/html/` V√Ä `COPY` file `nginx.conf` n√†y v√†o `/etc/nginx/conf.d/default.conf` (ghi ƒë√® config m·∫∑c ƒë·ªãnh c·ªßa Nginx).

4. **Vi·∫øt `docker-compose.yml`:**

   - ƒê·ªãnh nghƒ©a 2 services: `frontend` v√† `backend`.
   - Service `frontend`:
     - Build t·ª´ th∆∞ m·ª•c `frontend/`.
     - Map port host (v√≠ d·ª• 8080) t·ªõi port 80 c·ªßa container `frontend`.
   - Service `backend`:
     - Build t·ª´ th∆∞ m·ª•c `backend/`.
     - Expose port m√† API l·∫Øng nghe (v√≠ d·ª• 3000), nh∆∞ng kh√¥ng c·∫ßn map ra host n·∫øu ch·ªâ `frontend` g·ªçi.
   - ƒê·∫£m b·∫£o `frontend` `depends_on` `backend` (t√πy ch·ªçn, nh∆∞ng t·ªët).
   - C√°c services s·∫Ω t·ª± ƒë·ªông n·∫±m trong c√πng m·ªôt network m·∫∑c ƒë·ªãnh, `frontend` c√≥ th·ªÉ g·ªçi `backend` b·∫±ng t√™n service.

5. **Ch·∫°y v√† Ki·ªÉm tra:**
   - Ch·∫°y `docker-compose up --build`.
   - Truy c·∫≠p `http://localhost:8080` ƒë·ªÉ xem trang HTML tƒ©nh.
   - S·ª≠a `index.html` c·ªßa b·∫°n ƒë·ªÉ c√≥ m·ªôt n√∫t ho·∫∑c ƒëo·∫°n script JavaScript g·ªçi t·ªõi `/api/message` (v√≠ d·ª• d√πng `fetch API`) v√† hi·ªÉn th·ªã k·∫øt qu·∫£ l√™n trang.
   - Ki·ªÉm tra xem message t·ª´ backend c√≥ hi·ªÉn th·ªã ƒë√∫ng tr√™n frontend kh√¥ng.

**G·ª£i √Ω code JavaScript cho `index.html` ƒë·ªÉ g·ªçi API:**

```html
<!-- Th√™m v√†o trong <body> c·ªßa index.html -->
<button onclick="fetchMessage()">Get Message from Backend</button>
<p id="message_from_api"></p>

<script>
  async function fetchMessage() {
    try {
      const response = await fetch("/api/message"); // Nginx s·∫Ω proxy c√°i n√†y
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      document.getElementById("message_from_api").textContent = data.text;
    } catch (error) {
      document.getElementById("message_from_api").textContent =
        "Error: " + error.message;
      console.error("Error fetching message:", error);
    }
  }
</script>
```

## 9. üìö T√†i Li·ªáu Tham Kh·∫£o & Next Steps

- **Docker Docs:** [https://docs.docker.com/](https://docs.docker.com/)
- **Docker Compose Docs:** [https://docs.docker.com/compose/](https://docs.docker.com/compose/)
- **Best practices for writing Dockerfiles:** [https://docs.docker.com/develop/develop-images/dockerfile_best-practices/](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)
- **Awesome Docker (GitHub List):** [https://github.com/veggiemonk/awesome-docker](https://github.com/veggiemonk/awesome-docker)
- **Play with Docker (Online Docker playground):** [https://labs.play-with-docker.com/](https://labs.play-with-docker.com/)

**Next Steps:**

- T√¨m hi·ªÉu v·ªÅ **Multi-stage builds**.
- Nghi√™n c·ª©u **Docker Swarm** ho·∫∑c **Kubernetes (K8s)** cho orchestration ·ªü production scale.
- T√≠ch h·ª£p Docker v√†o **CI/CD pipelines**.
- Kh√°m ph√° c√°c **private registries** (AWS ECR, GCR, Azure CR, Harbor).
- T√¨m hi·ªÉu v·ªÅ **Docker security**.
